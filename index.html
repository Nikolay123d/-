<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>–ü—Ä–∞–≥–∞-–§—É—à–∫–∏ ‚Äî –î–æ–ø–æ–º–æ–≥–∞ —É–∫—Ä–∞—ó–Ω—Ü—è–º —É –ü—Ä–∞–∑—ñ</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap');
  /* –°–±—Ä–æ—Å */
  * {
    box-sizing: border-box;
  }
  body, html {
    margin: 0; padding: 0; height: 100%;
    font-family: 'Montserrat', sans-serif;
    background: url('https://i.ibb.co/fbpjfnm/Prague.jpg') no-repeat center center fixed;
    background-size: cover;
    color: #fff;
    overflow: hidden;
  }
  /* –í–∫–ª–∞–¥–∫–∏ —Å–≤–µ—Ä—Ö—É */
  .tabs {
    display: flex;
    background: rgba(255 223 0 / 0.85);
    user-select: none;
  }
  .tabs button {
    flex: 1;
    padding: 15px 0;
    font-weight: 700;
    font-size: 1.1rem;
    border: none;
    background: transparent;
    color: #fff;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }
  .tabs button.active,
  .tabs button:hover {
    background: #000000bb;
  }
  /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å —Å–æ–¥–µ—Ä–∂–∏–º—ã–º –≤–∫–ª–∞–¥–æ–∫ */
  .tab-content {
    position: absolute;
    top: 55px;
    left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.4);
    display: none;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }
  .tab-content.active {
    display: flex;
  }
  /* --- –ß–∞—Ç --- */
  #chat {
    display: flex;
    flex-direction: column;
    height: 100%;
  }
  #chat-header {
    background: rgba(255 223 0 / 0.9);
    color: #111;
    font-weight: 700;
    font-size: 1rem;
    padding: 12px 16px;
    text-align: center;
  }
  #messages {
    flex: 1;
    overflow-y: auto;
    padding: 12px 16px;
    background: rgba(0,0,0,0.3);
  }
  .message {
    margin-bottom: 12px;
    word-break: break-word;
    font-size: 1rem;
    border-radius: 8px;
    max-width: 75%;
    padding: 8px 12px;
    line-height: 1.3;
  }
  .message.sent {
    background-color: #ffdf0077;
    color: #222;
    align-self: flex-end;
  }
  .message.received {
    background-color: #222222cc;
    color: #eee;
    align-self: flex-start;
  }
  .message img {
    max-width: 100%;
    border-radius: 8px;
    margin-top: 6px;
  }
  /* –§–æ—Ä–º–∞ –≤–≤–æ–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏—è */
  #chat-input-area {
    display: flex;
    padding: 10px 16px;
    background: rgba(255 223 0 / 0.9);
    align-items: center;
  }
  #text-input {
    flex: 1;
    font-size: 1rem;
    padding: 8px 12px;
    border-radius: 25px;
    border: none;
    outline: none;
    margin-right: 10px;
    max-height: 40px;
  }
  #file-input {
    display: none;
  }
  #send-btn, #photo-btn {
    background: #222;
    border: none;
    color: #ffdf00;
    font-weight: 700;
    padding: 8px 14px;
    border-radius: 25px;
    cursor: pointer;
    transition: background-color 0.3s ease;
    user-select: none;
  }
  #send-btn:hover, #photo-btn:hover {
    background: #444;
  }
  #send-btn {
    margin-left: 8px;
  }
  /* –ö–Ω–æ–ø–∫–∞ —Ñ–æ—Ç–æ –∏ –æ–±–ª–∞—Å—Ç—å –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞ */
  #photo-btn {
    display: flex;
    align-items: center;
    justify-content: center;
  }
  #photo-btn svg {
    width: 20px;
    height: 20px;
    fill: #ffdf00;
  }

  /* --- –ö–∞—Ä—Ç–∞ --- */
  #map {
    flex: 1;
  }
  /* --- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è --- */
  #info-content {
    padding: 20px;
    overflow-y: auto;
    flex: 1;
    color: #fff;
    background: rgba(0,0,0,0.5);
  }
  #info-content h2 {
    margin-top: 0;
    font-weight: 700;
  }
  #info-content p {
    font-size: 1rem;
    line-height: 1.4;
  }
  #info-content img {
    max-width: 100%;
    margin-top: 12px;
    border-radius: 10px;
  }

  /* --- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ --- */
  #register-modal {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.8);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 9999;
  }
  #register-modal.active {
    display: flex;
  }
  #register-form {
    background: #fff;
    padding: 24px 32px;
    border-radius: 15px;
    width: 320px;
    max-width: 90%;
    box-shadow: 0 0 10px #00000099;
  }
  #register-form h2 {
    margin-top: 0;
    margin-bottom: 16px;
    color: #222;
    font-weight: 700;
    font-size: 1.3rem;
    text-align: center;
  }
  #register-form input {
    width: 100%;
    padding: 10px 12px;
    margin-bottom: 14px;
    border-radius: 8px;
    border: 1px solid #ccc;
    font-size: 1rem;
  }
  #register-form button {
    width: 100%;
    padding: 12px;
    border-radius: 25px;
    border: none;
    background: #ffdf00;
    color: #222;
    font-weight: 700;
    font-size: 1.1rem;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }
  #register-form button:hover {
    background: #e6cc00;
  }
  #register-close {
    text-align: right;
    margin-bottom: 12px;
    cursor: pointer;
    color: #444;
    font-weight: 700;
    font-size: 1.4rem;
  }
  
  /* –ê–¥–∞–ø—Ç–∏–≤ */
  @media (max-width: 768px) {
    #chat-input-area {
      flex-wrap: wrap;
    }
    #text-input {
      margin-right: 0;
      flex-basis: 100%;
      margin-bottom: 8px;
      max-height: 100px;
    }
    #send-btn {
      width: 100%;
      margin-left: 0;
    }
    .tabs button {
      font-size: 1rem;
      padding: 12px 0;
    }
  }
</style>

<!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
  integrity="sha256-sA+o0K/wqZqTTpJg9eM6LQkTJpov+oq6+Hn5U0UXhRQ=" crossorigin=""/>

</head>
<body>

<!-- –í–∫–ª–∞–¥–∫–∏ -->
<div class="tabs">
  <button class="active" data-tab="chat">–ß–∞—Ç</button>
  <button data-tab="map">–ö–∞—Ä—Ç–∞ –¥–æ–ø–æ–º–æ–≥–∏</button>
  <button data-tab="info">–Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è</button>
</div>

<!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤–∫–ª–∞–¥–æ–∫ -->
<div id="chat" class="tab-content active" role="region" aria-label="–ß–∞—Ç">
  <div id="chat-header">–®–∞–Ω–æ–≤–Ω—ñ —É–∫—Ä–∞—ó–Ω—Ü—ñ! –¶–µ–π —Å–∞–π—Ç —Å—Ç–≤–æ—Ä–µ–Ω–∏–π, —â–æ–± –¥–æ–ø–æ–º–∞–≥–∞—Ç–∏ –Ω–∞—à–∏–º —Å–ø—ñ–≤–≤—ñ—Ç—á–∏–∑–Ω–∏–∫–∞–º.</div>
  <div id="messages" aria-live="polite" aria-relevant="additions"></div>
  <div id="chat-input-area">
    <input type="text" id="text-input" placeholder="–í–≤–µ–¥—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..." aria-label="–ü–æ–ª–µ –¥–ª—è –≤–≤–µ–¥–µ–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è" />
    <label for="file-input" id="photo-btn" title="–î–æ–¥–∞—Ç–∏ —Ñ–æ—Ç–æ" aria-label="–î–æ–¥–∞—Ç–∏ —Ñ–æ—Ç–æ">
      üì∑
    </label>
    <input type="file" id="file-input" accept="image/*" />
    <button id="send-btn" aria-label="–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è">–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏</button>
  </div>
</div>

<div id="map" class="tab-content" role="region" aria-label="–ö–∞—Ä—Ç–∞ –¥–æ–ø–æ–º–æ–≥–∏">
  <div id="map" style="height:100%;"></div>
</div>

<div id="info" class="tab-content" role="region" aria-label="–Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è">
  <div id="info-content">
    <h2>–ö–æ—Ä–∏—Å–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –¥–ª—è —É–∫—Ä–∞—ó–Ω—Ü—ñ–≤ —É –ü—Ä–∞–∑—ñ</h2>
    <p>–¢—É—Ç –≤–∏ –∑–Ω–∞–π–¥–µ—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç–∏ –º–µ–¥–∏—á–Ω–∏—Ö –∑–∞–∫–ª–∞–¥—ñ–≤, –≤–æ–ª–æ–Ω—Ç–µ—Ä—Å—å–∫–∏—Ö —Ü–µ–Ω—Ç—Ä—ñ–≤, —é—Ä–∏–¥–∏—á–Ω–æ—ó –¥–æ–ø–æ–º–æ–≥–∏, –º–∞–≥–∞–∑–∏–Ω—ñ–≤ —ñ–∑ —É–∫—Ä–∞—ó–Ω—Å—å–∫–∏–º–∏ —Ç–æ–≤–∞—Ä–∞–º–∏ —Ç–∞ —ñ–Ω—à–µ.</p>
    <h3>–ú–µ–¥–∏—á–Ω—ñ –∑–∞–∫–ª–∞–¥–∏</h3>
    <ul>
      <li>–õ—ñ–∫–∞—Ä–Ω—è –ú–æ—Ç–æ–ª ‚Äì –≤—É–ª. –ö—Ä–µ–ø–µ—Ü—å–∫–∞, 1</li>
      <li>–ü–æ–ª—ñ–∫–ª—ñ–Ω—ñ–∫–∞ –ü—Ä–∞–≥–∞ 1 ‚Äì –≤—É–ª. –í–∞—Ü–ª–∞–≤—Å—å–∫–∞, 123</li>
      <li>–ê–ø—Ç–µ–∫–∞ ¬´–ó–¥–æ—Ä–æ–≤‚Äô—è¬ª ‚Äì –≤—É–ª. –ü—Ä–∞–≥–∞, 45</li>
    </ul>
    <h3>–í–æ–ª–æ–Ω—Ç–µ—Ä—Å—å–∫—ñ —Ü–µ–Ω—Ç—Ä–∏</h3>
    <ul>
      <li>OAMP –ü—Ä–∞–≥–∞ 1 ‚Äì –≤—É–ª. –ö–∞—Ä–ª–æ–≤–∞, 10</li>
      <li>–í–æ–ª–æ–Ω—Ç–µ—Ä—Å—å–∫–∏–π —Ü–µ–Ω—Ç—Ä Pomoc ‚Äì –≤—É–ª. –ù–æ–≤–∞, 7</li>
    </ul>
    <h3>–ú–∞–≥–∞–∑–∏–Ω–∏ –∑ —É–∫—Ä–∞—ó–Ω—Å—å–∫–∏–º–∏ —Ç–æ–≤–∞—Ä–∞–º–∏</h3>
    <ul>
      <li>–ú–∞–≥–∞–∑–∏–Ω Pomoc ‚Äì –≤—É–ª. –ü—Ä–∞–≥–∞, 15</li>
      <li>–£–∫—Ä–∞—ó–Ω—Å—å–∫–∏–π –±–∞–∑–∞—Ä ‚Äì –≤—É–ª. –ö—Ä–∞–∫—ñ–≤—Å—å–∫–∞, 22</li>
    </ul>
    <h3>–Æ—Ä–∏–¥–∏—á–Ω–∞ –¥–æ–ø–æ–º–æ–≥–∞</h3>
    <ul>
      <li>–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—è Pravda ‚Äì –≤—É–ª. –í–∞—Ü–ª–∞–≤—Å—å–∫–∞, 32</li>
      <li>–¶–µ–Ω—Ç—Ä —é—Ä–∏–¥–∏—á–Ω–æ—ó –ø—ñ–¥—Ç—Ä–∏–º–∫–∏ ‚Äì –≤—É–ª. –ù–æ–≤–∞, 14</li>
    </ul>
    <img src="https://cdn.pixabay.com/photo/2017/03/12/13/41/prague-2134747_960_720.jpg" alt="–ü—Ä–∞–≥–∞" />
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
<div id="register-modal" role="dialog" aria-modal="true" aria-labelledby="register-title">
  <form id="register-form" autocomplete="off">
    <div id="register-close" title="–ó–∞–∫—Ä–∏—Ç–∏">&times;</div>
    <h2 id="register-title">–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</h2>
    <input type="text" id="reg-nickname" placeholder="–ù—ñ–∫–Ω–µ–π–º" required autocomplete="username" />
    <input type="email" id="reg-email" placeholder="Email" required autocomplete="email" />
    <input type="password" id="reg-password" placeholder="–ü–∞—Ä–æ–ª—å" required autocomplete="new-password" minlength="6" />
    <button type="submit">–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è</button>
  </form>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-o9N1jQ9oRg9v3Q1j6LLTgO6P1gJx3Qv+1Z+9sE+QTHI="
  crossorigin=""></script>

<script>
  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyDV2BslF-Ll37a1XO3GEfzNMXa7YsSXL1o",
    authDomain: "web-app-b4633.firebaseapp.com",
    databaseURL: "https://web-app-b4633-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "web-app-b4633",
    storageBucket: "web-app-b4633.firebasestorage.app",
    messagingSenderId: "1041887915171",
    appId: "1:1041887915171:web:84d62eae54e9291b47a316",
    measurementId: "G-C65BPE81SJ"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const database = firebase.database();

  // –í–∫–ª–∞–¥–∫–∏
  const tabs = document.querySelectorAll('.tabs button');
  const contents = document.querySelectorAll('.tab-content');
  tabs.forEach(btn => {
    btn.addEventListener('click', () => {
      tabs.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      const tabName = btn.dataset.tab;
      contents.forEach(c => c.classList.toggle('active', c.id === tabName));
      if(tabName === 'map'){
        setTimeout(() => map.invalidateSize(), 200);
      }
    });
  });

  // –ö–∞—Ä—Ç–∞ Leaflet
  const map = L.map('map').setView([50.0755, 14.4378], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  // –¢–æ—á–∫–∏ –Ω–∞ –∫–∞—Ä—Ç–µ (–ø–æ–ø–æ–ª–Ω–∏–ª –¥–æ 20+)
  const points = [
    { name: '–õ—ñ–∫–∞—Ä–Ω—è –ú–æ—Ç–æ–ª', lat: 50.0737, lng: 14.3456 },
    { name: '–ü–æ–ª—ñ–∫–ª—ñ–Ω—ñ–∫–∞ –ü—Ä–∞–≥–∞ 1', lat: 50.082, lng: 14.423 },
    { name: 'OAMP –ü—Ä–∞–≥–∞ 1', lat: 50.087, lng: 14.423 },
    { name: '–í–æ–ª–æ–Ω—Ç–µ—Ä—Å—å–∫–∏–π —Ü–µ–Ω—Ç—Ä Pomoc', lat: 50.081, lng: 14.449 },
    { name: '–ú–∞–≥–∞–∑–∏–Ω Pomoc', lat: 50.073, lng: 14.418 },
    { name: '–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—è Pravda', lat: 50.085, lng: 14.420 },
    { name: '–ê–ø—Ç–µ–∫–∞ –ó–¥–æ—Ä–æ–≤‚Äô—è', lat: 50.076, lng: 14.435 },
    { name: '–¶–µ–Ω—Ç—Ä –º–µ–¥–∏—á–Ω–æ—ó –¥–æ–ø–æ–º–æ–≥–∏', lat: 50.090, lng: 14.440 },
    { name: '–í–æ–ª–æ–Ω—Ç–µ—Ä—Å—å–∫–∏–π –ø—É–Ω–∫—Ç "–î–æ–ø–æ–º–æ–≥–∞"', lat: 50.078, lng: 14.430 },
    { name: '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∏–π –∫—É–ª—å—Ç—É—Ä–Ω–∏–π —Ü–µ–Ω—Ç—Ä', lat: 50.079, lng: 14.422 },
    { name: '–ú–∞–≥–∞–∑–∏–Ω —É–∫—Ä–∞—ó–Ω—Å—å–∫–∏—Ö —Ç–æ–≤–∞—Ä—ñ–≤ "–ù–∞—à"', lat: 50.070, lng: 14.410 },
    { name: '–¶–µ–Ω—Ç—Ä —é—Ä–∏–¥–∏—á–Ω–æ—ó –ø—ñ–¥—Ç—Ä–∏–º–∫–∏', lat: 50.086, lng: 14.425 },
    { name: '–ë—ñ–±–ª—ñ–æ—Ç–µ–∫–∞ —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—ó –ª—ñ—Ç–µ—Ä–∞—Ç—É—Ä–∏', lat: 50.072, lng: 14.427 },
    { name: '–ü—É–Ω–∫—Ç –ø–µ—Ä—à–æ—ó –¥–æ–ø–æ–º–æ–≥–∏', lat: 50.083, lng: 14.433 },
    { name: '–¶–µ–Ω—Ç—Ä –∑–∞–π–Ω—è—Ç–æ—Å—Ç—ñ', lat: 50.084, lng: 14.428 },
    { name: '–ì—Ä–æ–º–∞–¥—Å—å–∫–∏–π —Ü–µ–Ω—Ç—Ä', lat: 50.075, lng: 14.435 },
    { name: '–ê–ø—Ç–µ–∫–∞ "–í—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è"', lat: 50.078, lng: 14.439 },
    { name: '–°–æ—Ü—ñ–∞–ª—å–Ω–∏–π —Ü–µ–Ω—Ç—Ä –ü—Ä–∞–≥–∞', lat: 50.080, lng: 14.418 },
    { name: '–í–æ–ª–æ–Ω—Ç–µ—Ä—Å—å–∫–∏–π –ø—É–Ω–∫—Ç "–†—É–∫–∞ –¥–æ–ø–æ–º–æ–≥–∏"', lat: 50.071, lng: 14.425 },
    { name: '–ú–∞–≥–∞–∑–∏–Ω –ø—Ä–æ–¥—É–∫—Ç—ñ–≤ "–°–º–∞—á–Ω–æ"', lat: 50.085, lng: 14.410 }
  ];

  points.forEach(p => {
    L.marker([p.lat, p.lng]).addTo(map).bindPopup(p.name);
  });

  // –ß–∞—Ç –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
  const messagesEl = document.getElementById('messages');
  const textInput = document.getElementById('text-input');
  const fileInput = document.getElementById('file-input');
  const sendBtn = document.getElementById('send-btn');
  const registerModal = document.getElementById('register-modal');
  const registerForm = document.getElementById('register-form');
  const regNickname = document.getElementById('reg-nickname');
  const regEmail = document.getElementById('reg-email');
  const regPassword = document.getElementById('reg-password');
  const registerClose = document.getElementById('register-close');

  let currentUser = null;

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
  auth.onAuthStateChanged(user => {
    if(user){
      currentUser = user;
      registerModal.classList.remove('active');
      loadMessages();
    } else {
      currentUser = null;
      // –ú–æ–∂–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –º–æ–¥–∞–ª–∫—É –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å
    }
  });

  // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ –ë–î
  function loadMessages(){
    const messagesRef = database.ref('messages').limitToLast(100);
    messagesRef.off(); // –°–Ω—è—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–ª—É—à–∞—Ç–µ–ª–∏
    messagesRef.on('value', snapshot => {
      messagesEl.innerHTML = '';
      snapshot.forEach(child => {
        const msg = child.val();
        const isCurrentUser = currentUser && msg.uid === currentUser.uid;
        const div = document.createElement('div');
        div.classList.add('message', isCurrentUser ? 'sent' : 'received');
        div.innerHTML = `<b>${escapeHtml(msg.nick || '–ê–Ω–æ–Ω—ñ–º')}</b>: ${escapeHtml(msg.text || '')}`;
        if(msg.image){
          const img = document.createElement('img');
          img.src = msg.image;
          img.alt = '–§–æ—Ç–æ';
          div.appendChild(img);
        }
        messagesEl.appendChild(div);
      });
      messagesEl.scrollTop = messagesEl.scrollHeight;
    });
  }

  // –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ html –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
  function escapeHtml(text){
    return text.replace(/[&<>"']/g, m => ({
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#39;'
    })[m]);
  }

  // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —Ñ–∞–π–ª–∞ –≤ base64
  function toBase64(file){
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = err => reject(err);
      reader.readAsDataURL(file);
    });
  }

  // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
  sendBtn.addEventListener('click', async () => {
    if(!currentUser){
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
      registerModal.classList.add('active');
      return;
    }
    const text = textInput.value.trim();
    if(!text && fileInput.files.length === 0) return;

    let imageData = null;
    if(fileInput.files.length > 0){
      try {
        imageData = await toBase64(fileInput.files[0]);
      } catch (e) {
        alert('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ —Ñ–æ—Ç–æ.');
        return;
      }
    }

    const newMsgRef = database.ref('messages').push();
    newMsgRef.set({
      uid: currentUser.uid,
      nick: currentUser.displayName || regNickname.value || '–ê–Ω–æ–Ω—ñ–º',
      text: text,
      image: imageData,
      timestamp: Date.now()
    });

    textInput.value = '';
    fileInput.value = '';
  });

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
  registerForm.addEventListener('submit', async e => {
    e.preventDefault();
    const nick = regNickname.value.trim();
    const email = regEmail.value.trim();
    const password = regPassword.value;

    if(!nick || !email || !password){
      alert('–ë—É–¥—å –ª–∞—Å–∫–∞, –∑–∞–ø–æ–≤–Ω—ñ—Ç—å –≤—Å—ñ –ø–æ–ª—è!');
      return;
    }

    try {
      const userCredential = await auth.createUserWithEmailAndPassword(email, password);
      await userCredential.user.updateProfile({ displayName: nick });
      currentUser = userCredential.user;
      registerModal.classList.remove('active');
      loadMessages();
    } catch (error) {
      alert('–ü–æ–º–∏–ª–∫–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó: ' + error.message);
    }
  });

  // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª–∫—É —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
  registerClose.addEventListener('click', () => {
    registerModal.classList.remove('active');
  });

  // –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ Enter –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞
  textInput.addEventListener('keydown', e => {
    if(e.key === 'Enter' && !e.shiftKey){
      e.preventDefault();
      sendBtn.click();
    }
  });

</script>
</body>
</html>
