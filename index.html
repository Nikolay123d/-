here<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>–ü—Ä–∞–≥–∞-–§—É—à–∫–∏ ‚Äî –î–æ–ø–æ–º–æ–≥–∞ —É–∫—Ä–∞—ó–Ω—Ü—è–º</title>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <!-- Leaflet CSS & JS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-sA+e2h7fHgJ0fl3Q3cN9kQvl70Nyn3MWvjZo3S0Bz/E="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-o0DdxqGZlZraNUW6P0GlUkLZwtZirixIbXq8t+Z1S5s="
    crossorigin=""
    defer
  ></script>

  <style>
    /* –°–±—Ä–æ—Å –∏ –±–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ */
    * {
      box-sizing: border-box;
    }
    body, html {
      margin: 0; padding: 0; height: 100%;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: url('https://i.ibb.co/fbpjfnm/Prague.jpg') no-repeat center center fixed;
      background-size: cover;
      color: #fff;
      overflow: hidden;
    }
    #app {
      height: 100vh;
      display: flex;
      flex-direction: column;
      background: rgba(0,0,0,0.5);
      backdrop-filter: blur(6px);
    }
    header {
      background: #ffdb00;
      padding: 10px 15px;
      color: #000;
      font-weight: 700;
      font-size: 1.1rem;
      text-align: center;
      user-select: none;
    }
    nav {
      display: flex;
      background: #ffdb00;
    }
    nav button {
      flex: 1;
      padding: 12px 0;
      font-weight: 700;
      font-size: 1rem;
      border: none;
      background: #ffdb00;
      color: #000;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    nav button.active,
    nav button:hover {
      background: #f7c700;
    }

    main {
      flex: 1;
      display: flex;
      position: relative;
      overflow: hidden;
    }
    section {
      flex: 1;
      display: none;
      flex-direction: column;
      height: 100%;
      overflow: hidden;
      background: rgba(255 255 255 / 0.15);
      border-left: 2px solid #ffdb00;
      border-right: 2px solid #ffdb00;
      backdrop-filter: blur(10px);
    }
    section.active {
      display: flex;
    }

    /* --- –ß–∞—Ç --- */
    #chat {
      display: flex;
      flex-direction: column;
      height: 100%;
      padding: 10px;
    }
    #chat-header {
      flex-shrink: 0;
      font-size: 0.85rem;
      margin-bottom: 8px;
      color: #ffdb00;
      font-weight: 600;
      text-align: center;
    }
    #messages {
      flex: 1;
      overflow-y: auto;
      padding: 5px 10px;
      border: 1px solid #ffdb00;
      border-radius: 8px;
      background: rgba(0,0,0,0.3);
      font-size: 0.95rem;
      line-height: 1.3;
    }
    .message {
      margin-bottom: 10px;
      padding: 6px 10px;
      border-radius: 15px;
      max-width: 75%;
      word-wrap: break-word;
      position: relative;
      clear: both;
      display: inline-block;
      font-family: 'Comic Sans MS', cursive, sans-serif;
      font-weight: 600;
      letter-spacing: 0.03em;
    }
    .message.sent {
      background-color: #ffdb00;
      color: #000;
      align-self: flex-end;
      float: right;
      border-bottom-right-radius: 2px;
    }
    .message.received {
      background-color: #333;
      color: #fff;
      align-self: flex-start;
      float: left;
      border-bottom-left-radius: 2px;
    }
    .message img {
      max-width: 150px;
      border-radius: 10px;
      margin-top: 5px;
      cursor: pointer;
      display: block;
    }

    #input-area {
      margin-top: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    #text-input {
      flex: 1;
      padding: 8px 12px;
      border-radius: 20px;
      border: none;
      font-size: 1rem;
      outline: none;
      resize: none;
      min-height: 40px;
      max-height: 100px;
      overflow-y: auto;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    #file-input {
      display: none;
    }
    #btn-photo {
      cursor: pointer;
      font-size: 1.3rem;
      background: none;
      border: none;
      color: #ffdb00;
      transition: color 0.3s ease;
    }
    #btn-photo:hover {
      color: #f7c700;
    }
    #send-btn {
      padding: 10px 16px;
      background: #ffdb00;
      border: none;
      border-radius: 20px;
      font-weight: 700;
      font-size: 1rem;
      color: #000;
      cursor: pointer;
      user-select: none;
      transition: background-color 0.3s ease;
      flex-shrink: 0;
    }
    #send-btn:disabled {
      background: #ccc;
      cursor: default;
      color: #666;
    }

    /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ */
    #register-modal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    #register-modal.active {
      display: flex;
    }
    #register-form {
      background: #222;
      padding: 20px 30px;
      border-radius: 10px;
      width: 320px;
      color: #ffdb00;
      font-weight: 600;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    #register-form label {
      font-size: 0.9rem;
    }
    #register-form input {
      padding: 8px 10px;
      border-radius: 6px;
      border: none;
      font-size: 1rem;
      outline: none;
      font-weight: normal;
      color: #000;
    }
    #register-submit {
      background: #ffdb00;
      border: none;
      border-radius: 20px;
      padding: 10px 0;
      font-weight: 700;
      cursor: pointer;
      font-size: 1rem;
      color: #000;
      user-select: none;
      transition: background-color 0.3s ease;
    }
    #register-submit:hover {
      background: #f7c700;
    }
    #register-error {
      color: #f44336;
      font-size: 0.85rem;
      min-height: 18px;
      margin-top: -8px;
    }

    /* --- –ö–∞—Ä—Ç–∞ --- */
    #map {
      flex: 1;
      border-radius: 10px;
      margin: 10px;
      min-height: 0; /* –ß—Ç–æ–±—ã –∑–∞–Ω—è—Ç—å –≤—Å—ë –º–µ—Å—Ç–æ */
    }
    #map-container {
      padding: 10px;
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    /* --- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è --- */
    #info-content {
      padding: 15px 20px;
      overflow-y: auto;
      flex: 1;
      font-size: 1rem;
      line-height: 1.5;
      color: #fff;
      background: rgba(0,0,0,0.35);
      border-radius: 10px;
      margin: 10px;
      user-select: text;
    }
    #info-content h2 {
      color: #ffdb00;
      margin-top: 0;
      font-weight: 700;
      font-size: 1.5rem;
    }
    #info-content p {
      margin-bottom: 1rem;
    }
    #info-content img {
      max-width: 100%;
      border-radius: 10px;
      margin-bottom: 1rem;
      display: block;
    }

    /* –ê–¥–∞–ø—Ç–∏–≤ */
    @media (max-width: 700px) {
      nav button {
        font-size: 0.9rem;
        padding: 10px 0;
      }
      #register-form {
        width: 90vw;
        padding: 15px 20px;
      }
      #text-input {
        min-height: 36px;
      }
    }
  </style>
</head>
<body>
  <div id="app">
    <header>–ü—Ä–∞–≥–∞-–§—É—à–∫–∏ ‚Äî –î–æ–ø–æ–º–æ–≥–∞ —É–∫—Ä–∞—ó–Ω—Ü—è–º</header>
    <nav>
      <button class="tab-btn active" data-tab="chat-tab">–ß–∞—Ç</button>
      <button class="tab-btn" data-tab="map-tab">–ö–∞—Ä—Ç–∞ –¥–æ–ø–æ–º–æ–≥–∏</button>
      <button class="tab-btn" data-tab="info-tab">–Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è</button>
    </nav>
    <main>
      <!-- –ß–∞—Ç -->
      <section id="chat-tab" class="active">
        <div id="chat-header">–®–∞–Ω–æ–≤–Ω—ñ —É–∫—Ä–∞—ó–Ω—Ü—ñ! –¶–µ–π —Å–∞–π—Ç —Å—Ç–≤–æ—Ä–µ–Ω–∏–π –¥–ª—è –¥–æ–ø–æ–º–æ–≥–∏ –Ω–∞—à–∏–º —Å–ø—ñ–≤–≤—ñ—Ç—á–∏–∑–Ω–∏–∫–∞–º —É –ü—Ä–∞–∑—ñ.</div>
        <div id="messages" aria-live="polite" aria-atomic="false"></div>
        <div id="input-area">
          <textarea id="text-input" placeholder="–í–≤–µ–¥—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..." rows="1"></textarea>
          <input type="file" id="file-input" accept="image/*" />
          <button id="btn-photo" title="–î–æ–¥–∞—Ç–∏ —Ñ–æ—Ç–æ" aria-label="–î–æ–¥–∞—Ç–∏ —Ñ–æ—Ç–æ">üì∑</button>
          <button id="send-btn" disabled>–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏</button>
        </div>
      </section>

      <!-- –ö–∞—Ä—Ç–∞ -->
      <section id="map-tab">
        <div id="map-container">
          <div id="map" role="application" aria-label="–ö–∞—Ä—Ç–∞ –¥–æ–ø–æ–º–æ–≥–∏"></div>
          <div class="filter-buttons" style="margin-top: 10px; text-align: center;">
            <button data-filter="all" class="active">–í—Å—ñ</button>
            <button data-filter="medicine">–ú–µ–¥–∏—Ü–∏–Ω–∞</button>
            <button data-filter="social">–°–æ—Ü—Å–ª—É–∂–±–∏</button>
            <button data-filter="shops">–ú–∞–≥–∞–∑–∏–Ω–∏</button>
            <button data-filter="law">–Æ—Ä–∏–¥–∏—á–Ω–∞ –¥–æ–ø–æ–º–æ–≥–∞</button>
          </div>
        </div>
      </section>

      <!-- –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è -->
      <section id="info-tab">
        <div id="info-content" tabindex="0">
          <h2>–Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –¥–ª—è —É–∫—Ä–∞—ó–Ω—Ü—ñ–≤ —É –ü—Ä–∞–∑—ñ</h2>
          <p>–õ–∞—Å–∫–∞–≤–æ –ø—Ä–æ—Å–∏–º–æ –Ω–∞ –Ω–∞—à —Å–∞–π—Ç ¬´–ü—Ä–∞–≥–∞-–§—É—à–∫–∏¬ª ‚Äî –º—ñ—Å—Ü–µ, –¥–µ –≤–∏ –∑–Ω–∞–π–¥–µ—Ç–µ –∫–æ—Ä–∏—Å–Ω—É —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é, –ø—ñ–¥—Ç—Ä–∏–º–∫—É —Ç–∞ –¥–æ–ø–æ–º–æ–≥—É.</p>
          <p>–¢—É—Ç –≤–∏ –º–æ–∂–µ—Ç–µ —Å–ø—ñ–ª–∫—É–≤–∞—Ç–∏—Å—è —É —á–∞—Ç—ñ, –ø–µ—Ä–µ–≥–ª—è–¥–∞—Ç–∏ –∫–∞—Ä—Ç—É –∑ –≤–∞–∂–ª–∏–≤–∏–º–∏ –º—ñ—Å—Ü—è–º–∏, —Ç–∞ –¥—ñ–∑–Ω–∞–≤–∞—Ç–∏—Å—è –∞–∫—Ç—É–∞–ª—å–Ω—ñ –Ω–æ–≤–∏–Ω–∏ –π –ø–æ—Ä–∞–¥–∏.</p>
          <img src="https://i.ibb.co/2dFKNvM/helping-hands.jpg" alt="–î–æ–ø–æ–º–æ–≥–∞ —É–∫—Ä–∞—ó–Ω—Ü—è–º" />
          <h3>–û—Å–Ω–æ–≤–Ω—ñ –∫–æ–Ω—Ç–∞–∫—Ç–∏:</h3>
          <ul>
            <li><strong>–ú–µ–¥–∏—Ü–∏–Ω–∞:</strong> –õ—ñ–∫–∞—Ä–Ω—è –ú–æ—Ç–æ–ª, –¢–µ–ª: +420 224 433 333</li>
            <li><strong>–°–æ—Ü—Å–ª—É–∂–±–∏:</strong> –¶–µ–Ω—Ç—Ä –¥–æ–ø–æ–º–æ–≥–∏ Pomoc, –¢–µ–ª: +420 123 456 789</li>
            <li><strong>–ú–∞–≥–∞–∑–∏–Ω–∏:</strong> –£–∫—Ä–∞—ó–Ω—Å—å–∫—ñ –º–∞–≥–∞–∑–∏–Ω–∏ —É –ü—Ä–∞–∑—ñ</li>
            <li><strong>–Æ—Ä–∏–¥–∏—á–Ω–∞ –¥–æ–ø–æ–º–æ–≥–∞:</strong> –ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—è Pravda, –¢–µ–ª: +420 987 654 321</li>
          </ul>
          <img src="https://i.ibb.co/HF6xDcg/ukraine-prague.jpg" alt="–ü—Ä–∞–≥–∞ —ñ –£–∫—Ä–∞—ó–Ω–∞" />
          <p>–ú–∏ —Ä–∞–∑–æ–º! –í—ñ—Ä–∏–º–æ —É –∫—Ä–∞—â–µ –º–∞–π–±—É—Ç–Ω—î –£–∫—Ä–∞—ó–Ω–∏ —Ç–∞ —ó—ó –Ω–∞—Ä–æ–¥—É.</p>
        </div>
      </section>
    </main>

    <!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó -->
    <div id="register-modal" role="dialog" aria-modal="true" aria-labelledby="register-title">
      <form id="register-form" novalidate>
        <h2 id="register-title" style="color:#ffdb00; text-align:center;">–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</h2>
        <label for="nickname">–ù—ñ–∫–Ω–µ–π–º</label>
        <input type="text" id="nickname" name="nickname" required autocomplete="off" />
        <label for="email">Email</label>
        <input type="email" id="email" name="email" required autocomplete="off" />
        <label for="password">–ü–∞—Ä–æ–ª—å</label>
        <input type="password" id="password" name="password" required autocomplete="off" minlength="6" />
        <div id="register-error" aria-live="assertive"></div>
        <button type="submit" id="register-submit">–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è</button>
      </form>
    </div>
  </div>

  <script>
    // === Firebase config ===
    const firebaseConfig = {
      apiKey: "AIzaSyDV2BslF-Ll37a1XO3GEfzNMXa7YsSXL1o",
      authDomain: "web-app-b4633.firebaseapp.com",
      databaseURL: "https://web-app-b4633-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "web-app-b4633",
      storageBucket: "web-app-b4633.firebasestorage.app",
      messagingSenderId: "1041887915171",
      appId: "1:1041887915171:web:84d62eae54e9291b47a316",
      measurementId: "G-C65BPE81SJ"
    };
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // --- UI elements ---
    const tabs = document.querySelectorAll("nav button.tab-btn");
    const sections = document.querySelectorAll("main section");
    const messagesContainer = document.getElementById("messages");
    const textInput = document.getElementById("text-input");
    const fileInput = document.getElementById("file-input");
    const sendBtn = document.getElementById("send-btn");
    const btnPhoto = document.getElementById("btn-photo");

    const registerModal = document.getElementById("register-modal");
    const registerForm = document.getElementById("register-form");
    const registerError = document.getElementById("register-error");
    const nicknameInput = document.getElementById("nickname");
    const emailInput = document.getElementById("email");
    const passwordInput = document.getElementById("password");

    let currentUser = null;
    let messages = [];

    // --- –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫ ---
    tabs.forEach(tab => {
      tab.addEventListener("click", () => {
        tabs.forEach(t => t.classList.remove("active"));
        tab.classList.add("active");
        const target = tab.dataset.tab;
        sections.forEach(sec => {
          sec.classList.toggle("active", sec.id === target);
        });
        if (target === "map-tab") {
          map.invalidateSize(); // –ß—Ç–æ–±—ã –∫–∞—Ä—Ç–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞–ª–∞—Å—å –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è
        }
      });
    });

    // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã Leaflet ---
    const map = L.map("map").setView([50.0755, 14.4378], 13);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution:
        '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
    }).addTo(map);

    // –ú–∞—Ä–∫–µ—Ä—ã –∫–∞—Ç–µ–≥–æ—Ä–∏–π
    const categories = {
      all: [],
      medicine: [
        { name: "–õ—ñ–∫–∞—Ä–Ω—è –ú–æ—Ç–æ–ª", lat: 50.0737, lng: 14.3456 },
        { name: "–ü–æ–ª—ñ–∫–ª—ñ–Ω—ñ–∫–∞ –ü—Ä–∞–≥–∞ 1", lat: 50.082, lng: 14.423 },
        { name: "–ê–ø—Ç–µ–∫–∞ U Lva", lat: 50.0815, lng: 14.440 },
      ],
      social: [
        { name: "OAMP –ü—Ä–∞–≥–∞ 1", lat: 50.087, lng: 14.423 },
        { name: "–í–æ–ª–æ–Ω—Ç–µ—Ä—Å—å–∫–∏–π —Ü–µ–Ω—Ç—Ä Pomoc", lat: 50.081, lng: 14.449 },
        { name: "–¶–µ–Ω—Ç—Ä –¥–æ–ø–æ–º–æ–≥–∏ —É–∫—Ä–∞—ó–Ω—Ü—è–º", lat: 50.073, lng: 14.428 },
      ], 
      shops: [
        { name: "–ú–∞–≥–∞–∑–∏–Ω Pomoc", lat: 50.080, lng: 14.420 },
        { name: "–£–∫—Ä–∞—ó–Ω—Å—å–∫–∏–π –º–∞–≥–∞–∑–∏–Ω –≤ –ü—Ä–∞–∑—ñ", lat: 50.079, lng: 14.430 },
        { name: "–ü—Ä–æ–¥—É–∫—Ç–æ–≤–∏–π –º–∞–≥–∞–∑–∏–Ω", lat: 50.074, lng: 14.435 },
      ],
      law: [
        { name: "–Æ—Ä–∏–¥–∏—á–Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—è Pravda", lat: 50.077, lng: 14.425 },
        { name: "–ü—Ä–∞–≤–æ–≤–∞ –¥–æ–ø–æ–º–æ–≥–∞", lat: 50.075, lng: 14.438 },
        { name: "–ê–¥–≤–æ–∫–∞—Ç—Å—å–∫–∞ –∫–æ–Ω—Ç–æ—Ä–∞", lat: 50.076, lng: 14.433 },
      ],
    };

    // –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ –º–∞—Ä–∫–µ—Ä—ã –≤ –æ–±—â–∏–π —Å–ø–∏—Å–æ–∫ all
    categories.all = [
      ...categories.medicine,
      ...categories.social,
      ...categories.shops,
      ...categories.law,
    ];

    let markersGroup = L.layerGroup().addTo(map);

    function showMarkers(category) {
      markersGroup.clearLayers();
      let points = category === "all" ? categories.all : categories[category];
      points.forEach(({ name, lat, lng }) => {
        const marker = L.marker([lat, lng]).addTo(markersGroup);
        marker.bindPopup(`<b>${name}</b>`);
      });
    }

    // –ò–∑–Ω–∞—á–∞–ª—å–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ
    showMarkers("all");

    // –§–∏–ª—å—Ç—Ä –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
    document.querySelectorAll(".filter-buttons button").forEach((btn) => {
      btn.addEventListener("click", () => {
        document.querySelectorAll(".filter-buttons button").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        showMarkers(btn.dataset.filter);
      });
    });

    // --- –ß–∞—Ç —Å Firebase ---

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ localStorage
    function loadUser() {
      const storedUser = localStorage.getItem("pragaFushkiUser");
      if (storedUser) {
        try {
          return JSON.parse(storedUser);
        } catch {
          return null;
        }
      }
      return null;
    }

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    function saveUser(user) {
      localStorage.setItem("pragaFushkiUser", JSON.stringify(user));
    }

    currentUser = loadUser();

    // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω, —Å–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
    if (currentUser) {
      registerModal.classList.remove("active");
      sendBtn.disabled = false;
    }

    // –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª–∫—É —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
    function showRegister() {
      registerModal.classList.add("active");
      nicknameInput.focus();
    }

    // –°–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª–∫—É —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
    function hideRegister() {
      registerModal.classList.remove("active");
      registerError.textContent = "";
    }

    // –†–µ–Ω–¥–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —á–∞—Ç
    function renderMessages() {
      messagesContainer.innerHTML = "";
      messages.forEach(({ uid, nickname, text, img, timestamp }) => {
        const msgDiv = document.createElement("div");
        msgDiv.classList.add("message");
        msgDiv.classList.add(uid === (currentUser && currentUser.uid) ? "sent" : "received");
        const time = new Date(timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        msgDiv.innerHTML = `<strong>${nickname || '–ê–Ω–æ–Ω—ñ–º'}</strong> <small style="font-size:0.7rem;color:#ccc;">${time}</small><br/>`;
        if (text) {
          msgDiv.innerHTML += `<span>${escapeHtml(text)}</span>`;
        }
        if (img) {
          const image = document.createElement("img");
          image.src = img;
          image.alt = "–ü—Ä–∏–∫—Ä—ñ–ø–ª–µ–Ω–µ —Ñ–æ—Ç–æ";
          msgDiv.appendChild(image);
        }
        messagesContainer.appendChild(msgDiv);
      });
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ html –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
    function escapeHtml(text) {
      return text.replace(/[&<>"']/g, function(m) {
        return {
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#39;'
        }[m];
      });
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ Firebase
    function listenMessages() {
      db.ref("messages").limitToLast(100).on("value", (snapshot) => {
        const val = snapshot.val();
        messages = [];
        for (let key in val) {
          messages.push(val[key]);
        }
        messages.sort((a,b) => a.timestamp - b.timestamp);
        renderMessages();
      });
    }
    listenMessages();

    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
    sendBtn.addEventListener("click", () => {
      const text = textInput.value.trim();
      if (!text && !fileInput.files.length) return;

      if (!currentUser) {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –ø—Ä–∏ –ø–µ—Ä–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏
        showRegister();
        return;
      }

      sendMessage(text, fileInput.files[0]);
    });

    // –ù–∞–∂–∞—Ç–∏–µ Enter –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ (–±–µ–∑ shift)
    textInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendBtn.click();
      }
    });

    // –ö–Ω–æ–ø–∫–∞ —Ñ–æ—Ç–æ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –¥–∏–∞–ª–æ–≥ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞
    btnPhoto.addEventListener("click", () => {
      fileInput.click();
    });

    // –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Ñ–æ—Ç–æ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —Ñ–∞–π–ª–∞ (–º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å, –Ω–æ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ)
    fileInput.addEventListener("change", () => {
      // –ü–æ–∫–∞ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä, —Ç.–∫. —ç—Ç–æ –Ω–µ –±—ã–ª–æ –≤ –¢–ó –≤ –≤–∏–¥–µ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
      // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å, –µ—Å–ª–∏ –Ω–∞–¥–æ ‚Äî —Å–æ–æ–±—â–∏
    });

    // –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–º —Ñ–æ—Ç–æ
    function sendMessage(text, file) {
      sendBtn.disabled = true;
      if (file) {
        const reader = new FileReader();
        reader.onload = () => {
          const imgData = reader.result;
          saveMessage(text, imgData);
        };
        reader.readAsDataURL(file);
      } else {
        saveMessage(text, null);
      }
    }

    // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Firebase
    function saveMessage(text, imgData) {
      const msgData = {
        uid: currentUser.uid,
        nickname: currentUser.nickname,
        text: text || "",
        img: imgData || null,
        timestamp: Date.now(),
      };
      db.ref("messages").push(msgData).then(() => {
        textInput.value = "";
        fileInput.value = "";
        sendBtn.disabled = false;
      }).catch(() => {
        alert("–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ.");
        sendBtn.disabled = false;
      });
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
    registerForm.addEventListener("submit", (e) => {
      e.preventDefault();
      registerError.textContent = "";

      const nickname = nicknameInput.value.trim();
      const email = emailInput.value.trim();
      const password = passwordInput.value;

      if (!nickname || !email || !password) {
        registerError.textContent = "–£—Å—ñ –ø–æ–ª—è –æ–±–æ–≤'—è–∑–∫–æ–≤—ñ";
        return;
      }
      if (password.length < 6) {
        registerError.textContent = "–ü–∞—Ä–æ–ª—å –º–∞—î –±—É—Ç–∏ –Ω–µ –º–µ–Ω—à–µ 6 —Å–∏–º–≤–æ–ª—ñ–≤";
        return;
      }

      auth.createUserWithEmailAndPassword(email, password)
        .then((userCredential) => {
          currentUser = {
            uid: userCredential.user.uid,
            email: email,
            nickname: nickname,
          };
          saveUser(currentUser);
          hideRegister();
          // –û—Ç–ø—Ä–∞–≤–∏–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
          db.ref("messages").push({
            uid: currentUser.uid,
            nickname: currentUser.nickname,
            text: "–ü—Ä–∏—î–¥–Ω–∞–≤—Å—è –¥–æ —á–∞—Ç—É!",
            img: null,
            timestamp: Date.now(),
          });
          sendBtn.disabled = false;
        })
        .catch((error) => {
          if (error.code === "auth/email-already-in-use") {
            registerError.textContent = "–¶–µ–π Email –≤–∂–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è.";
          } else if (error.code === "auth/invalid-email") {
            registerError.textContent = "–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç Email.";
          } else {
            registerError.textContent = error.message;
          }
        });
    });

    // –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, –≤–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É –æ—Ç–ø—Ä–∞–≤–∏—Ç—å
    if (currentUser) {
      sendBtn.disabled = false;
    }

    // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω, –∑–∞–ø—Ä–µ—Ç–∏—Ç—å –≤–≤–æ–¥
    textInput.addEventListener("input", () => {
      sendBtn.disabled = textInput.value.trim() === "" && fileInput.files.length === 0;
    });

  </script>
</body>
</html
