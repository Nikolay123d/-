<!doctype html>
<html lang="uk">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>–ü–†–ê–ì–ê –§–£–®–ö–ò ‚Äî –ß–∞—Ç</title>

<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=UnifrakturCook:wght@700&family=Poppins:wght@600;700&display=swap" rel="stylesheet">

<style>
:root{
  --accent:#2ecc71;
  --glass: rgba(255,255,255,0.96);
  --muted:#94a3b8;
  --max-width:980px;
  --avatar-size:44px;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Poppins, Inter, Arial, sans-serif;-webkit-font-smoothing:antialiased;background:#071126;color:#fff}

/* Background Prague (fixed) */
body::before{
  content:"";
  position:fixed;
  inset:0;
  background-image:url('https://i.ibb.co/27hgtZfY/Prague.jpg');
  background-size:cover;
  background-position:center;
  background-attachment:fixed;
  filter:brightness(0.52);
  z-index:-2;
}
body::after{
  content:"";
  position:fixed;
  inset:0;
  background:linear-gradient(180deg, rgba(3,7,18,0.10), rgba(3,7,18,0.25));
  z-index:-1;
}

/* Header / tabs */
.header{
  position:sticky; top:0; z-index:60;
  display:flex; align-items:center; justify-content:space-between;
  gap:12px;padding:14px 16px; background:rgba(2,6,23,0.32); backdrop-filter: blur(4px);
}
.title{
  font-family:Poppins, Inter, sans-serif; font-weight:700; font-size:22px; letter-spacing:2px;
  color:#fff; text-shadow:0 8px 30px rgba(2,6,23,0.6);
}
.subtitle{font-size:13px;color:#e8f5e9;opacity:0.95}

/* Tabs */
.tabs{display:flex;gap:8px; margin-left:auto}
.tab-button{
  background:rgba(255,255,255,0.06);
  color:#fff;border:0;padding:8px 14px;border-radius:10px;font-weight:700;cursor:pointer;
}
.tab-button.active{box-shadow: inset 0 -4px 0 var(--accent);background:rgba(255,255,255,0.08)}

/* container */
.container{max-width:var(--max-width);margin:12px auto;padding:8px}

/* content panels */
.panel{display:none}
.panel.active{display:block}

/* system message */
.sys-msg{max-width:var(--max-width);margin:10px auto;padding:12px;border-radius:12px;background:rgba(255,255,255,0.03);color:#fff;text-align:center}

/* Chat */
.chat-area{height:calc(100vh - 320px);overflow:auto;padding:16px;background:transparent}
.messages{display:flex;flex-direction:column;gap:12px;padding-bottom:160px}
.message{display:flex;gap:10px;align-items:flex-start;max-width:78%;word-break:break-word}
.message.self{margin-left:auto;flex-direction:row-reverse}
.avatar{width:var(--avatar-size);height:var(--avatar-size);border-radius:50%;object-fit:cover;flex:0 0 var(--avatar-size);box-shadow:0 3px 10px rgba(0,0,0,0.35);cursor:pointer}
.message-content{background:var(--glass);padding:10px 12px;border-radius:14px;box-shadow:0 6px 24px rgba(2,6,23,0.12);color:#0b1220}
.message.self .message-content{background:#E9FFF0}
.message-meta{font-size:12px;color:var(--muted);margin-bottom:6px}
.chat-image{max-width:320px;border-radius:8px;margin-top:8px;display:block}

/* input bar */
.input-bar{position:fixed;left:0;right:0;bottom:0;padding:12px;background:linear-gradient(180deg, rgba(255,255,255,0.95), rgba(255,255,255,0.98));border-top:1px solid rgba(0,0,0,0.06);z-index:70;display:flex;gap:8px;align-items:center;max-width:var(--max-width);margin:0 auto}
.camera-btn{display:inline-flex;align-items:center;justify-content:center;cursor:pointer;width:48px;height:48px;border-radius:50%;background:#fff;border:1px solid #e6e6e6}
.camera-btn svg{width:20px;height:20px}
.input-bar input[type="text"]{flex:1;padding:12px 14px;border-radius:24px;border:1px solid #d0d7de;font-size:16px;outline:none}
.send-btn{background:var(--accent);color:#fff;border:none;padding:10px 16px;border-radius:20px;font-weight:700;cursor:pointer;box-shadow:0 8px 20px rgba(46,204,113,0.18)}

/* profile button */
.profile-btn{position:fixed;right:14px;top:14px;z-index:100;width:48px;height:48px;border-radius:50%;border:2px solid #fff;background-size:cover;background-position:center;cursor:pointer}

/* map */
.map-panel{height:calc(100vh - 240px);background:rgba(255,255,255,0.03);border-radius:12px;padding:6px}
.map-canvas{width:100%;height:100%;border-radius:10px}

/* help cards */
.help-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;padding:12px}
.help-card{background:#fff;padding:10px;border-radius:10px;box-shadow:0 6px 22px rgba(2,6,23,0.12)}
.help-card img{width:100%;height:140px;object-fit:cover;border-radius:8px}

/* small screens */
@media (max-width:640px){
  .chat-area{height:calc(100vh - 420px)}
  .chat-image{max-width:200px}
  .title{font-size:18px}
}
</style>
</head>
<body>
  <div class="header">
    <div>
      <div class="title">–ü–†–ê–ì–ê –§–£–®–ö–ò</div>
      <div class="subtitle">–í—ñ—Ç–∞—î–º–æ! –î–æ—Ä–æ–≥—ñ —É–∫—Ä–∞—ó–Ω—Ü—ñ ‚Äî —Ü–µ–π —á–∞—Ç —Å—Ç–≤–æ—Ä–µ–Ω–æ, —â–æ–± –¥–æ–ø–æ–º–∞–≥–∞—Ç–∏ –Ω–∞—à–∏–º —Å–ø—ñ–≤–≤—ñ—Ç—á–∏–∑–Ω–∏–∫–∞–º.</div>
    </div>

    <div class="tabs" role="tablist" aria-label="–í–∫–ª–∞–¥–∫–∏">
      <button class="tab-button active" data-target="chatPanel" aria-selected="true">üí¨ –ß–∞—Ç</button>
      <button class="tab-button" data-target="mapPanel">üó∫Ô∏è –ö–∞—Ä—Ç–∞</button>
      <button class="tab-button" data-target="helpPanel">‚ùì –î–æ–ø–æ–º–æ–≥–∞</button>
    </div>
  </div>

  <main class="container" role="main">
    <div class="sys-msg">–Ø–∫—â–æ –≤–∏ –≤–ø–µ—Ä—à–µ ‚Äî –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å ¬´–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏¬ª ‚Äî –∑'—è–≤–∏—Ç—å—Å—è —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—è. –£ –≤–∞—Å 6 –≥–æ–¥–∏–Ω –¥–æ—Å—Ç—É–ø—É –±–µ–∑ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è email.</div>

    <!-- CHAT PANEL -->
    <section id="chatPanel" class="panel active" role="region" aria-label="–ß–∞—Ç">
      <div class="chat-area" id="chatArea" aria-live="polite">
        <div id="messages" class="messages" role="log"></div>
      </div>
    </section>

    <!-- MAP PANEL -->
    <section id="mapPanel" class="panel" role="region" aria-label="–ö–∞—Ä—Ç–∞">
      <div class="map-panel">
        <div id="map" class="map-canvas"></div>
      </div>
    </section>

    <!-- HELP PANEL -->
    <section id="helpPanel" class="panel" role="region" aria-label="–î–æ–ø–æ–º–æ–≥–∞">
      <h2 style="color:#fff">–¢–µ—Ä–º—ñ–Ω–æ–≤–∞ –¥–æ–ø–æ–º–æ–≥–∞ —É –ü—Ä–∞–∑—ñ</h2>
      <div class="help-grid" id="helpGrid">
        <article class="help-card">
          <img src="https://i.ibb.co/TqWJ9VTM/palata-vchehii-jpg.webp" alt="–ë–æ–ª—å–Ω–∏—Ü–∞">
          <h3>Nemocnice Motol</h3>
          <p>–ê–¥—Ä–µ—Å–∞: V Uvalu 84</p>
        </article>
        <article class="help-card">
          <img src="https://i.ibb.co/0gWD5wW/images-5.jpg" alt="–Æ—Ä–∏—Å—Ç–∏">
          <h3>–Æ—Ä–∏–¥–∏—á–Ω–∞ –¥–æ–ø–æ–º–æ–≥–∞</h3>
          <p>–î–æ–∫—É–º–µ–Ω—Ç–∏ —Ç–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—ó</p>
        </article>
        <article class="help-card">
          <img src="https://i.ibb.co/R49shL6k/images-6.jpg" alt="–ú–∞–≥–∞–∑–∏–Ω—ã">
          <h3>–£–∫—Ä–∞—ó–Ω—Å—å–∫–∏–π –º–∞–≥–∞–∑–∏–Ω</h3>
          <p>–¢–æ–≤–∞—Ä–∏ —Ç–∞ –ø—Ä–æ–¥—É–∫—Ç–∏</p>
        </article>
      </div>
    </section>
  </main>

  <!-- profile btn -->
  <button id="profileBtn" class="profile-btn" title="–ü—Ä–æ—Ñ—ñ–ª—å" aria-label="–ü—Ä–æ—Ñ—ñ–ª—å"></button>

  <!-- hidden file input -->
  <input id="fileInput" type="file" accept="image/*" style="display:none" />

  <!-- input bar -->
  <div class="input-bar" role="region" aria-label="–í—ñ–¥–ø—Ä–∞–≤–∫–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è">
    <label for="fileInput" class="camera-btn" id="cameraLabel" title="–î–æ–¥–∞—Ç–∏ —Ñ–æ—Ç–æ" aria-hidden="true">
      <svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true"><path d="M4 7H6L7 5H17L18 7H20C21.1 7 22 7.9 22 9V19C22 20.1 21.1 21 20 21H4C2.9 21 2 20.1 2 19V9C2 7.9 2.9 7 4 7Z" fill="#111"/><circle cx="12" cy="13" r="3.5" fill="#fff"/></svg>
    </label>

    <input id="messageInput" type="text" inputmode="text" placeholder="–ù–∞–ø–∏—à—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..." aria-label="–¢–µ–∫—Å—Ç –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è" />
    <button id="sendButton" class="send-btn">–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏</button>
  </div>

  <!-- auth modal -->
  <div id="authModal" style="display:none;position:fixed;inset:0;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:95" aria-hidden="true">
    <div style="background:#fff;border-radius:12px;padding:18px;width:92%;max-width:420px;position:relative">
      <button id="authClose" style="position:absolute;right:10px;top:8px;border:none;background:transparent;font-size:18px;cursor:pointer">‚úï</button>
      <h2 id="authTitle">–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è / –í—Ö—ñ–¥</h2>

      <form id="registerForm" onsubmit="return false;">
        <input id="nickInput" type="text" placeholder="–ü—Å–µ–≤–¥–æ–Ω—ñ–º" required style="width:100%;padding:10px;margin:8px 0;border-radius:8px;border:1px solid #dcdcdc" />
        <input id="emailInput" type="email" placeholder="Email" required style="width:100%;padding:10px;margin:8px 0;border-radius:8px;border:1px solid #dcdcdc" />
        <input id="passwordInput" type="password" placeholder="–ü–∞—Ä–æ–ª—å (–º—ñ–Ω—ñ–º—É–º 6)" required style="width:100%;padding:10px;margin:8px 0;border-radius:8px;border:1px solid #dcdcdc" />
        <div style="display:flex;gap:8px">
          <button id="registerSubmit" type="button" style="flex:1;padding:10px;border-radius:8px;border:none;background:var(--accent);color:#fff;cursor:pointer">–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è</button>
          <button id="loginShow" type="button" style="flex:1;padding:10px;border-radius:8px;border:none;background:#4b5563;color:#fff;cursor:pointer">–£–≤—ñ–π—Ç–∏</button>
        </div>
        <div id="regError" style="color:#b91c1c;margin-top:8px"></div>
      </form>

      <form id="loginForm" style="display:none" onsubmit="return false;">
        <input id="loginEmail" type="email" placeholder="Email" required style="width:100%;padding:10px;margin:8px 0;border-radius:8px;border:1px solid #dcdcdc" />
        <input id="loginPassword" type="password" placeholder="–ü–∞—Ä–æ–ª—å" required style="width:100%;padding:10px;margin:8px 0;border-radius:8px;border:1px solid #dcdcdc" />
        <div style="display:flex;gap:8px">
          <button id="loginSubmit" type="button" style="flex:1;padding:10px;border-radius:8px;border:none;background:var(--accent);color:#fff;cursor:pointer">–£–≤—ñ–π—Ç–∏</button>
          <button id="backToRegister" type="button" style="flex:1;padding:10px;border-radius:8px;border:none;background:#4b5563;color:#fff;cursor:pointer">–ù–∞–∑–∞–¥</button>
        </div>
        <div id="loginError" style="color:#b91c1c;margin-top:8px"></div>
      </form>
    </div>
  </div>

  <!-- Firebase modular SDK + app logic (module) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, updateProfile, sendEmailVerification, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    import { getDatabase, ref as dbRef, push as dbPush, onChildAdded, query, orderByChild, limitToLast, get as dbGet, set as dbSet } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
    import { getStorage, ref as stRef, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";

    // ---------- CONFIG (use your existing config) ----------
    const firebaseConfig = {
      apiKey: "AIzaSyBFrxVhpb6nHJ6rhiLl5Ho8t0jOb1iEQNc",
      authDomain: "praga-4baee.firebaseapp.com",
      databaseURL: "https://praga-4baee-default-rtdb.firebaseio.com",
      projectId: "praga-4baee",
      storageBucket: "praga-4baee.appspot.com",
      messagingSenderId: "336023952536",
      appId: "1:336023952536:web:f7437feaa25b6eadcd04ed",
      measurementId: "G-BGDJD6R12N"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const storage = getStorage(app);

    // DOM refs
    const tabButtons = document.querySelectorAll('.tab-button');
    const panels = document.querySelectorAll('.panel');
    const messagesEl = document.getElementById('messages');
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');
    const fileInput = document.getElementById('fileInput');
    const cameraLabel = document.getElementById('cameraLabel');
    const authModal = document.getElementById('authModal');
    const registerForm = document.getElementById('registerForm');
    const loginForm = document.getElementById('loginForm');
    const nickInput = document.getElementById('nickInput');
    const emailInput = document.getElementById('emailInput');
    const passwordInput = document.getElementById('passwordInput');
    const registerSubmit = document.getElementById('registerSubmit');
    const loginShow = document.getElementById('loginShow');
    const loginSubmit = document.getElementById('loginSubmit');
    const backToRegister = document.getElementById('backToRegister');
    const loginEmail = document.getElementById('loginEmail');
    const loginPassword = document.getElementById('loginPassword');
    const authClose = document.getElementById('authClose');
    const regError = document.getElementById('regError');
    const loginError = document.getElementById('loginError');
    const profileBtn = document.getElementById('profileBtn');

    const DEFAULT_AVATAR = "https://i.ibb.co/Fqq6sH5q/istockphoto-1495088043-612x612.jpg";
    let currentUser = null;
    const MSG_LIMIT = 100; // last messages to load

    // Tabs handling
    function setActiveTab(id) {
      tabButtons.forEach(b => b.classList.toggle('active', b.dataset.target === id));
      panels.forEach(p => p.classList.toggle('active', p.id === id));
      // focus chat input when opening chat
      if (id === 'chatPanel') setTimeout(()=> messageInput.focus(), 100);
      // if map panel - trigger resize
      if (id === 'mapPanel' && window.map) {
        setTimeout(()=> {
          google.maps.event.trigger(window.map,'resize');
          if (window.mapCenter) window.map.setCenter(window.mapCenter);
        }, 200);
      }
    }
    tabButtons.forEach(btn => btn.addEventListener('click', ()=> setActiveTab(btn.dataset.target)));

    // Auth modal control
    function showAuthModal(){ document.getElementById('authModal').style.display = 'flex'; document.getElementById('authModal').setAttribute('aria-hidden','false'); regError.textContent=''; loginError.textContent=''; }
    function hideAuthModal(){ document.getElementById('authModal').style.display = 'none'; document.getElementById('authModal').setAttribute('aria-hidden','true'); }
    loginShow?.addEventListener('click', ()=>{ registerForm.style.display='none'; loginForm.style.display='block'; });
    backToRegister?.addEventListener('click', ()=>{ registerForm.style.display='block'; loginForm.style.display='none'; });
    authClose?.addEventListener('click', hideAuthModal);

    // register
    registerSubmit?.addEventListener('click', async ()=>{
      regError.textContent = '';
      const nick = nickInput.value.trim();
      const email = emailInput.value.trim();
      const pass = passwordInput.value.trim();
      if (!nick || !email || !pass) { regError.textContent = "–ó–∞–ø–æ–≤–Ω—ñ—Ç—å —É—Å—ñ –ø–æ–ª—è"; return; }
      if (pass.length < 6) { regError.textContent = "–ü–∞—Ä–æ–ª—å –º—ñ–Ω—ñ–º—É–º 6 —Å–∏–º–≤–æ–ª—ñ–≤"; return; }
      try {
        const cred = await createUserWithEmailAndPassword(auth, email, pass);
        await updateProfile(cred.user, { displayName: nick, photoURL: DEFAULT_AVATAR });
        await dbSet(dbRef(db, `users/${cred.user.uid}`), { nick, email, avatar: DEFAULT_AVATAR, createdAt: Date.now() });
        localStorage.setItem("regTime_" + cred.user.uid, String(Date.now()));
        await sendEmailVerification(cred.user);
        hideAuthModal();
        alert("–í–∏ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω—ñ. –õ–∏—Å—Ç –¥–ª—è –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ. –£ –≤–∞—Å 6 –≥–æ–¥–∏–Ω –¥–æ—Å—Ç—É–ø—É –±–µ–∑ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è.");
      } catch (err) {
        console.error("register err", err);
        regError.textContent = err?.message || String(err);
      }
    });

    // login
    loginSubmit?.addEventListener('click', async ()=>{
      loginError.textContent = '';
      const email = loginEmail.value.trim();
      const pass = loginPassword.value.trim();
      if (!email || !pass) { loginError.textContent = "–ó–∞–ø–æ–≤–Ω—ñ—Ç—å email —ñ –ø–∞—Ä–æ–ª—å"; return; }
      try {
        await signInWithEmailAndPassword(auth, email, pass);
        hideAuthModal();
      } catch (err) {
        console.error("login err", err);
        loginError.textContent = err?.message || String(err);
      }
    });

    // auth state listener
    onAuthStateChanged(auth, (user) => {
      currentUser = user;
      if (user) profileBtn.style.background = `url(${user.photoURL || DEFAULT_AVATAR}) center/cover`;
      else profileBtn.style.background = `url(${DEFAULT_AVATAR}) center/cover`;
    });

    // canSendMessage (emailVerified OR within 6 hours from createdAt)
    async function canSendMessage(){
      const user = auth.currentUser;
      if (!user) return false;
      if (user.emailVerified) return true;
      const localKey = "regTime_" + user.uid;
      const localVal = localStorage.getItem(localKey);
      const sixHours = 6 * 60 * 60 * 1000;
      if (localVal && (Date.now() - Number(localVal) < sixHours)) return true;
      try {
        const snap = await dbGet(dbRef(db, `users/${user.uid}/createdAt`));
        if (snap && snap.exists()) {
          const created = Number(snap.val());
          if (!Number.isNaN(created) && Date.now() - created < sixHours) {
            localStorage.setItem(localKey, String(created));
            return true;
          }
        }
      } catch (e){ console.error("canSendMessage db get error", e); }
      return false;
    }

    // render message
    function timeStr(ts){ return new Date(ts).toLocaleString(); }
    function renderMessage(m){
      if (!m || !m.ts) return;
      const wrap = document.createElement('div');
      wrap.className = 'message' + ((currentUser && m.uid === currentUser.uid) ? ' self' : '');
      const avatar = document.createElement('img');
      avatar.className = 'avatar';
      avatar.src = m.avatar || DEFAULT_AVATAR;
      avatar.alt = m.nick || 'avatar';
      avatar.title = m.nick || '–ü—Ä–æ—Ñ—ñ–ª—å';
      avatar.addEventListener('click', ()=> {
        if (!currentUser) { showAuthModal(); return; }
        if (m.uid === currentUser.uid) alert('–¶–µ –≤–∏'); else alert('–û—Å–æ–±–∏—Å—Ç—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø–æ–∫–∏ —â–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ñ.');
      });

      const txt = document.createElement('div');
      txt.className = 'message-content';
      const meta = document.createElement('div');
      meta.className = 'message-meta';
      meta.textContent = `${m.nick || '–ê–Ω–æ–Ω—ñ–º'} ¬∑ ${timeStr(m.ts)}` + (m.recipientUid ? ' ¬∑ –æ—Å–æ–±–∏—Å—Ç–µ' : '');
      txt.appendChild(meta);

      if (m.text) {
        const p = document.createElement('div');
        p.innerText = m.text;
        txt.appendChild(p);
      }
      if (m.image) {
        const im = document.createElement('img');
        im.src = m.image;
        im.alt = '–§–æ—Ç–æ';
        im.className = 'chat-image';
        txt.appendChild(im);
      }

      wrap.appendChild(avatar);
      wrap.appendChild(txt);
      messagesEl.appendChild(wrap);

      // autoscroll if user near bottom
      const chatArea = document.querySelector('.chat-area');
      chatArea.scrollTop = chatArea.scrollHeight;
    }

    // subscribe last messages and new ones
    const messagesQuery = query(dbRef(db, "messages"), orderByChild("ts"), limitToLast(MSG_LIMIT));
    onChildAdded(messagesQuery, (snap) => {
      const m = snap.val();
      renderMessage(m);
    }, (err) => {
      console.error("onChildAdded error", err);
    });

    // image resize helper (client-side) -> returns dataURL (JPEG)
    function resizeImageFile(file, maxWidth = 1200, quality = 0.8){
      return new Promise((resolve,reject)=>{
        const reader = new FileReader();
        const img = new Image();
        reader.onload = (e)=>{
          img.onload = ()=>{
            const scale = Math.min(1, maxWidth / img.width);
            const w = Math.round(img.width * scale);
            const h = Math.round(img.height * scale);
            const canvas = document.createElement('canvas');
            canvas.width = w;
            canvas.height = h;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img,0,0,w,h);
            const dataUrl = canvas.toDataURL('image/jpeg', quality);
            resolve(dataUrl);
          };
          img.onerror = reject;
          img.src = e.target.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    // send message (text + optional image upload to Storage)
    sendButton.addEventListener('click', async ()=>{
      if (!auth.currentUser) { showAuthModal(); return; }
      if (!await canSendMessage()) { alert("–ü—ñ–¥—Ç–≤–µ—Ä–¥—ñ—Ç—å email –∞–±–æ —Å–∫–æ—Ä–∏—Å—Ç–∞–π—Ç–µ—Å—å 6-–≥–æ–¥–∏–Ω–Ω–∏–º –¥–æ—Å—Ç—É–ø–æ–º –ø—ñ—Å–ª—è —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó."); return; }

      const text = messageInput.value.trim();
      const file = fileInput.files[0];

      if (!text && !file) return;

      let imageUrl = null;
      if (file) {
        try {
          // resize to reduce upload size (optional)
          const resizedDataUrl = await resizeImageFile(file, 1200, 0.8);
          // convert dataURL to blob
          const res = await fetch(resizedDataUrl);
          const blob = await res.blob();
          const storageReference = stRef(storage, `chat_images/${auth.currentUser.uid}/${Date.now()}_${file.name}`);
          const uploadTask = uploadBytesResumable(storageReference, blob);
          await new Promise((resol, rej)=>{
            uploadTask.on('state_changed', null, (err)=> rej(err), async ()=> {
              imageUrl = await getDownloadURL(uploadTask.snapshot.ref);
              resol();
            });
          });
        } catch (err) {
          console.error("upload error", err);
          alert("–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–æ—Ç–æ");
          return;
        }
      }

      const msg = {
        uid: auth.currentUser.uid,
        nick: auth.currentUser.displayName || auth.currentUser.email || '–ê–Ω–æ–Ω—ñ–º',
        avatar: auth.currentUser.photoURL || DEFAULT_AVATAR,
        text: text || null,
        image: imageUrl || null,
        ts: Date.now(),
        recipientUid: null
      };

      try {
        await dbPush(dbRef(db,'messages'), msg);
        messageInput.value = '';
        fileInput.value = '';
      } catch (err) {
        console.error("dbPush error", err);
        alert("–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è");
      }
    });

    // Enter to send
    messageInput.addEventListener('keydown', (e)=>{
      if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendButton.click(); }
    });

    // Camera label click -> if not logged show auth
    cameraLabel.addEventListener('click', (e)=>{
      if (!auth.currentUser) { e.preventDefault(); showAuthModal(); return; }
      // else default file chooser opens
    });

    // profile button
    profileBtn.style.background = `url(${DEFAULT_AVATAR}) center/cover`;
    profileBtn.addEventListener('click', ()=>{
      if (!auth.currentUser) { showAuthModal(); return; }
      if (confirm("–í–∏ —Ö–æ—á–µ—Ç–µ –≤–∏–π—Ç–∏? OK ‚Äî –≤–∏–π—Ç–∏; Cancel ‚Äî –∑–∞–ª–∏—à–∏—Ç–∏—Å—è.")) {
        signOut(auth);
        profileBtn.style.background = `url(${DEFAULT_AVATAR}) center/cover`;
        alert("–í–∏ –≤–∏–π—à–ª–∏");
      }
    });

    // preload background image to avoid blank flash
    (function preloadBg(){ const img = new Image(); img.src = 'https://i.ibb.co/27hgtZfY/Prague.jpg'; })();

    // Expose initMap to window for Google Maps callback ‚Äî define skeleton here, will be filled later
    window.initMap = function(){ console.log('map not initialized yet'); };

    // END of module
  </script>

  <!-- Google Maps JS: load AFTER module so window.initMap can be overridden below -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBFrxVhpb6nHJ6rhiLl5Ho8t0jOb1iEQNc&callback=__initMap" async defer></script>

  <script>
    // Map code (separate script so google callback works)
    // We'll create actual init and assign to window.__initMap called by callback
    window.__initMap = function(){
      const center = { lat: 50.0755, lng: 14.4378 };
      window.mapCenter = center;
      window.map = new google.maps.Map(document.getElementById('map'), {
        center,
        zoom: 13,
        gestureHandling: 'greedy'
      });

      // Icons (your images)
      const ICONS = {
        hospital: "https://i.ibb.co/TqWJ9VTM/palata-vchehii-jpg.webp",
        lawyer: "https://i.ibb.co/0gWD5wW/images-5.jpg",
        shop: "https://i.ibb.co/R49shL6k/images-6.jpg",
        avatar: "https://i.ibb.co/Fqq6sH5q/istockphoto-1495088043-612x612.jpg"
      };

      const POINTS = [
        { title: "Nemocnice Motol (–ë–æ–ª—å–Ω–∏—Ü–∞)", pos:{lat:50.057, lng:14.378}, img:ICONS.hospital, cat:'hospital' },
        { title: "–Æ—Ä–∏–¥–∏—á–Ω–∞ –¥–æ–ø–æ–º–æ–≥–∞ / Law office", pos:{lat:50.083, lng:14.412}, img:ICONS.lawyer, cat:'lawyer' },
        { title: "–£–∫—Ä–∞—ó–Ω—Å—å–∫–∏–π –º–∞–≥–∞–∑–∏–Ω", pos:{lat:50.084, lng:14.417}, img:ICONS.shop, cat:'shop' },
        { title: "–ü—É–Ω–∫—Ç –¥–æ–ø–æ–º–æ–≥–∏", pos:{lat:50.082, lng:14.419}, img:ICONS.avatar, cat:'avatar' },
        // add more if needed...
      ];

      function createIcon(url){
        return {
          url,
          scaledSize: new google.maps.Size(48,48)
        };
      }

      POINTS.forEach(p=>{
        const mk = new google.maps.Marker({
          position: p.pos,
          map: window.map,
          title: p.title,
          icon: createIcon(p.img)
        });
        const iw = new google.maps.InfoWindow({ content: `<div style="min-width:160px"><strong>${p.title}</strong><div style="margin-top:6px"><img src="${p.img}" style="width:100%;border-radius:6px"></div></div>` });
        mk.addListener('click', ()=> iw.open(window.map, mk));
      });

      // when user switches to map tab, trigger resize
      document.querySelectorAll('.tab-button').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          if (btn.dataset.target === 'mapPanel') {
            setTimeout(()=>{ google.maps.event.trigger(window.map,'resize'); window.map.setCenter(window.mapCenter); }, 250);
          }
        });
      });
    };

    // Make maps callback call our wrapper
    window.initMap = window.__initMap;
  </script>

</body>
</html>
