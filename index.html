<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ü–†–ê–ì–ê –§–£–®–ö–ò ‚Äî –î–æ–ø–æ–º–æ–≥–∞ —É–∫—Ä–∞—ó–Ω—Ü—è–º</title>

  <!-- –®—Ä–∏—Ñ—Ç–∏ -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Poppins:wght@600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --accent:#2ecc71;
      --muted:#64748b;
      --glass: rgba(255,255,255,0.96);
      --max-width:980px;
      --avatar-size:44px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter, "Segoe UI", Arial, sans-serif;-webkit-font-smoothing:antialiased;color:#0b1220;background:#071126}

    /* –§–æ–Ω –ü—Ä–∞–≥–∞ ‚Äî —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π, cover, –∑–∞—Ç–µ–º–Ω–µ–Ω–∏–µ */
    body::before{
      content:"";
      position:fixed;
      inset:0;
      background-image:url('https://i.ibb.co/27hgtZfY/Prague.jpg');
      background-size:cover;
      background-position:center;
      background-attachment:fixed;
      filter:brightness(0.52);
      z-index:-2;
      will-change:transform;
    }
    body::after{
      content:"";
      position:fixed;
      inset:0;
      background:linear-gradient(180deg, rgba(3,7,18,0.25), rgba(3,7,18,0.38));
      z-index:-1;
    }

    /* Header */
    header.site-header{position:sticky;top:0;z-index:60;padding:18px 12px;text-align:center;color:#fff;backdrop-filter:blur(3px)}
    header.site-header h1{margin:0;font-family:Poppins, Inter, sans-serif;font-weight:700;font-size:28px;letter-spacing:1px;text-shadow:0 10px 30px rgba(2,6,23,0.6)}
    header.site-header p{margin:8px 0 0;font-size:14px;color:#e8f5e9}

    /* Tabs */
    nav.tabs{display:flex;gap:10px;justify-content:center;padding:10px 12px;position:sticky;top:78px;z-index:58}
    .tab-button{background:transparent;border:none;color:#fff;padding:8px 16px;font-weight:700;border-radius:12px;cursor:pointer}
    .tab-button.active{box-shadow: inset 0 -4px 0 var(--accent);background:rgba(255,255,255,0.03)}

    main.container{max-width:var(--max-width);margin:0 auto;padding:12px}
    .sys-msg{max-width:var(--max-width);margin:12px auto;padding:12px;border-radius:14px;background:rgba(255,255,255,0.04);color:#fff;font-size:15px;text-align:center}

    .tab-content{display:none}
    .tab-content.active{display:block}

    /* Chat */
    .chat-wrap{position:relative}
    .chat-area{height:calc(100vh - 320px);overflow:auto;padding:14px 8px;background:transparent}
    .messages{display:flex;flex-direction:column;gap:12px;padding-bottom:120px}
    .message{display:flex;gap:10px;align-items:flex-start;max-width:78%;word-break:break-word}
    .message.self{margin-left:auto;flex-direction:row-reverse}
    .avatar{width:var(--avatar-size);height:var(--avatar-size);border-radius:50%;object-fit:cover;flex:0 0 var(--avatar-size);box-shadow:0 3px 10px rgba(0,0,0,0.3);cursor:pointer}
    .message-content{background:var(--glass);padding:10px 12px;border-radius:14px;box-shadow:0 4px 18px rgba(2,6,23,0.12);color:#0b1220}
    .message.self .message-content{background:#E9FFF0}
    .message-meta{font-size:12px;color:var(--muted);margin-bottom:6px}
    .chat-image{max-width:260px;border-radius:8px;margin-top:6px;display:block}

    /* Chat input */
    .chat-input{position:fixed;left:0;right:0;bottom:0;padding:12px;background:linear-gradient(180deg, rgba(255,255,255,0.95), rgba(255,255,255,0.98));border-top:1px solid rgba(0,0,0,0.06);z-index:70;display:flex;gap:8px;align-items:center;max-width:var(--max-width);margin:0 auto}
    .camera-btn{display:inline-flex;align-items:center;justify-content:center;cursor:pointer;width:48px;height:48px;border-radius:50%;background:#fff;border:1px solid #e6e6e6}
    .camera-btn svg{width:20px;height:20px}
    .chat-input input[type="text"]{flex:1;padding:12px 14px;border-radius:24px;border:1px solid #d0d7de;font-size:16px;outline:none}
    .send-btn{background:var(--accent);color:#fff;border:none;padding:10px 16px;border-radius:20px;font-weight:700;cursor:pointer;box-shadow:0 8px 20px rgba(46,204,113,0.18)}

    /* Map */
    .map-controls{display:flex;justify-content:space-between;align-items:center;padding:8px;background:rgba(255,255,255,0.9);border-radius:8px;margin:8px 0}
    .filter-buttons{display:flex;gap:8px;flex-wrap:wrap}
    .filter-btn{padding:8px 12px;border-radius:10px;border:1px solid #ddd;background:#fff;cursor:pointer}
    .filter-btn.active{background:var(--accent);color:#fff;border-color:var(--accent)}
    #map{width:100%;height:calc(100vh - 220px);border-radius:12px;overflow:hidden}

    /* Help */
    .help-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;padding:12px}
    .help-card{background:rgba(255,255,255,0.96);padding:10px;border-radius:10px;box-shadow:0 8px 30px rgba(2,6,23,0.06)}
    .help-card img{width:100%;height:140px;object-fit:cover;border-radius:8px}

    /* Modal */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:95}
    .modal.show{display:flex}
    .modal-panel{background:#fff;border-radius:12px;padding:18px;width:92%;max-width:460px;position:relative;box-shadow:0 18px 80px rgba(2,6,23,0.4)}
    .modal-close{position:absolute;right:10px;top:8px;background:transparent;border:none;font-size:16px;cursor:pointer}
    .auth-form input{width:100%;padding:10px;margin:8px 0;border-radius:8px;border:1px solid #dcdcdc}
    .auth-actions{display:flex;gap:8px;justify-content:space-between}
    .auth-actions button{flex:1;padding:10px;border-radius:8px;border:none;background:var(--accent);color:#fff;cursor:pointer}
    .error-line{color:#b91c1c;font-size:13px;margin-top:6px}

    /* Profile */
    .profile-btn{position:fixed;right:12px;top:12px;z-index:100;width:48px;height:48px;border-radius:50%;border:2px solid #fff;background-size:cover;background-position:center;cursor:pointer}

    @media (max-width:640px){
      header.site-header h1{font-size:20px}
      .chat-area{height:calc(100vh - 360px)}
      .chat-input{padding:8px}
      .chat-image{max-width:180px}
    }
  </style>
</head>
<body>
  <header class="site-header" role="banner">
    <h1>–ü–†–ê–ì–ê –§–£–®–ö–ò</h1>
    <p>–í—ñ—Ç–∞—î–º–æ! –î–æ—Ä–æ–≥—ñ —É–∫—Ä–∞—ó–Ω—Ü—ñ ‚Äî —Ü–µ–π —á–∞—Ç —Å—Ç–≤–æ—Ä–µ–Ω–æ, —â–æ–± –¥–æ–ø–æ–º–∞–≥–∞—Ç–∏ –Ω–∞—à–∏–º —Å–ø—ñ–≤–≤—ñ—Ç—á–∏–∑–Ω–∏–∫–∞–º.</p>
  </header>

  <nav class="tabs" role="tablist" aria-label="–í–∫–ª–∞–¥–∫–∏">
    <button class="tab-button active" data-target="chatTab" aria-selected="true">üí¨ –ß–∞—Ç</button>
    <button class="tab-button" data-target="mapTab">üó∫Ô∏è –ö–∞—Ä—Ç–∞</button>
    <button class="tab-button" data-target="helpTab">‚ùì –î–æ–ø–æ–º–æ–≥–∞</button>
  </nav>

  <main class="container" role="main">
    <div class="sys-msg">–Ø–∫—â–æ –≤–∏ –≤–ø–µ—Ä—à–µ ‚Äî –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å "–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏" ‚Äî –∑'—è–≤–∏—Ç—å—Å—è —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—è. 6 –≥–æ–¥–∏–Ω –¥–æ—Å—Ç—É–ø—É –±–µ–∑ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è email.</div>

    <!-- CHAT -->
    <section id="chatTab" class="tab-content active" role="region" aria-label="–ß–∞—Ç">
      <div class="chat-wrap">
        <div class="chat-area" id="chatArea" aria-live="polite">
          <div id="messages" class="messages" role="log"></div>
        </div>
      </div>
    </section>

    <!-- MAP -->
    <section id="mapTab" class="tab-content" role="region" aria-label="–ö–∞—Ä—Ç–∞ –¥–æ–ø–æ–º–æ–≥–∏" style="display:none;">
      <div class="map-controls">
        <div class="filter-buttons">
          <button class="filter-btn active" data-cat="all">–£—Å—ñ</button>
          <button class="filter-btn" data-cat="hospital">–ú–µ–¥–∏—Ü–∏–Ω–∞</button>
          <button class="filter-btn" data-cat="lawyer">–Æ—Ä–∏—Å—Ç–∏</button>
          <button class="filter-btn" data-cat="shop">–ú–∞–≥–∞–∑–∏–Ω–∏</button>
          <button class="filter-btn" data-cat="help">–¶–µ–Ω—Ç—Ä–∏</button>
        </div>
        <div style="font-size:13px;color:#0b1220">Hotkeys: C=–ß–∞—Ç M=–ö–∞—Ä—Ç–∞ H=–î–æ–ø–æ–º–æ–≥–∞</div>
      </div>
      <div id="map" aria-label="–ö–∞—Ä—Ç–∞"></div>
    </section>

    <!-- HELP -->
    <section id="helpTab" class="tab-content" role="region" aria-label="–î–æ–ø–æ–º–æ–≥–∞" style="display:none;">
      <h2 style="color:#fff;margin:8px 0">–¢–µ—Ä–º—ñ–Ω–æ–≤–∞ –¥–æ–ø–æ–º–æ–≥–∞ —É –ü—Ä–∞–∑—ñ</h2>
      <div class="help-grid" id="helpGrid">
        <article class="help-card">
          <img src="https://i.ibb.co/TqWJ9VTM/palata-vchehii-jpg.webp" alt="–ë–æ–ª—å–Ω–∏—Ü–∞">
          <h3>Nemocnice Motol</h3>
          <p>–ì–æ–ª–æ–≤–Ω–∞ –ª—ñ–∫–∞—Ä–Ω—è –ü—Ä–∞–≥–∏. –ê–¥—Ä–µ—Å–∞: V Uvalu 84</p>
        </article>
        <article class="help-card">
          <img src="https://i.ibb.co/0gWD5wW/images-5.jpg" alt="–Æ—Ä–∏—Å—Ç–∏">
          <h3>–Æ—Ä–∏–¥–∏—á–Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—è</h3>
          <p>–î–æ–ø–æ–º–æ–≥–∞ –∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏ —Ç–∞ –ø—Ä–∞–≤–æ–≤–∏–º–∏ –ø–∏—Ç–∞–Ω–Ω—è–º–∏.</p>
        </article>
        <article class="help-card">
          <img src="https://i.ibb.co/R49shL6k/images-6.jpg" alt="–ú–∞–≥–∞–∑–∏–Ω">
          <h3>–£–∫—Ä–∞—ó–Ω—Å—å–∫–∏–π –º–∞–≥–∞–∑–∏–Ω</h3>
          <p>–ü—Ä–æ–¥—É–∫—Ç–∏ —Ç–∞ —Ç–æ–≤–∞—Ä–∏ –¥–ª—è —É–∫—Ä–∞—ó–Ω—Ü—ñ–≤.</p>
        </article>
        <article class="help-card">
          <img src="https://i.ibb.co/Fqq6sH5q/istockphoto-1495088043-612x612.jpg" alt="–í–æ–ª–æ–Ω—Ç–µ—Ä–∏">
          <h3>–í–æ–ª–æ–Ω—Ç–µ—Ä–∏</h3>
          <p>–ö–æ–Ω—Ç–∞–∫—Ç–∏ –≤–æ–ª–æ–Ω—Ç–µ—Ä—Å—å–∫–∏—Ö —ñ–Ω—ñ—Ü—ñ–∞—Ç–∏–≤ —Ç–∞ –≥—Ä—É–ø –ø—ñ–¥—Ç—Ä–∏–º–∫–∏.</p>
        </article>
      </div>
    </section>
  </main>

  <!-- profile -->
  <button id="profileBtn" class="profile-btn" title="–ü—Ä–æ—Ñ—ñ–ª—å" aria-label="–ü—Ä–æ—Ñ—ñ–ª—å"></button>

  <!-- hidden file input -->
  <input id="fileInput" type="file" accept="image/*" style="display:none" />

  <!-- chat input -->
  <div class="chat-input" role="region" aria-label="–í—ñ–¥–ø—Ä–∞–≤–∫–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è">
    <label for="fileInput" class="camera-btn" title="–î–æ–¥–∞—Ç–∏ —Ñ–æ—Ç–æ">
      <svg viewBox="0 0 24 24" fill="none" aria-hidden="true" xmlns="http://www.w3.org/2000/svg">
        <path d="M4 7H6L7 5H17L18 7H20C21.1 7 22 7.9 22 9V19C22 20.1 21.1 21 20 21H4C2.9 21 2 20.1 2 19V9C2 7.9 2.9 7 4 7Z" stroke="#111" stroke-width="1.2" fill="#fff"/>
        <circle cx="12" cy="13" r="3.5" stroke="#111" stroke-width="1.2" fill="#fff"/>
      </svg>
    </label>

    <input id="messageInput" type="text" inputmode="text" placeholder="–ù–∞–ø–∏—à—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..." aria-label="–¢–µ–∫—Å—Ç –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è" />
    <button id="sendButton" class="send-btn" aria-label="–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è">–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏</button>
  </div>

  <!-- auth modal -->
  <div id="authModal" class="modal" aria-hidden="true">
    <div class="modal-panel" role="dialog" aria-modal="true" aria-labelledby="authTitle">
      <button class="modal-close" id="modalClose" aria-label="–ó–∞–∫—Ä–∏—Ç–∏">‚úï</button>
      <h2 id="authTitle">–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è / –í—Ö—ñ–¥</h2>

      <form id="registerForm" class="auth-form" onsubmit="return false;">
        <input id="nickInput" type="text" placeholder="–ü—Å–µ–≤–¥–æ–Ω—ñ–º" required />
        <input id="emailInput" type="email" placeholder="Email" required />
        <input id="passwordInput" type="password" placeholder="–ü–∞—Ä–æ–ª—å (min 6)" required />
        <div class="auth-actions">
          <button id="registerSubmit" type="button">–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—å</button>
          <button id="loginShow" type="button" style="background:#4b5563">–£–≤—ñ–π—Ç–∏</button>
        </div>
        <div id="regError" class="error-line" aria-live="polite"></div>
        <p class="note" style="font-size:13px;color:#666;margin-top:8px">–ü—ñ—Å–ª—è —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó —É –≤–∞—Å 6 –≥–æ–¥–∏–Ω –¥–æ—Å—Ç—É–ø—É –±–µ–∑ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è email.</p>
      </form>

      <form id="loginForm" class="auth-form" style="display:none;" onsubmit="return false;">
        <input id="loginEmail" type="email" placeholder="Email" required />
        <input id="loginPassword" type="password" placeholder="–ü–∞—Ä–æ–ª—å" required />
        <div class="auth-actions">
          <button id="loginSubmit" type="button">–£–≤—ñ–π—Ç–∏</button>
          <button id="backToRegister" type="button" style="background:#4b5563">–ù–∞–∑–∞–¥</button>
        </div>
        <div id="loginError" class="error-line" aria-live="polite"></div>
      </form>
    </div>
  </div>

  <!-- Firebase + main script -->
  <script type="module">
  // Firebase modular SDK v9
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, updateProfile, sendEmailVerification, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
  import { getDatabase, ref as dbRef, push as dbPush, onChildAdded, query, orderByChild, limitToLast, get as dbGet } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
  import { getStorage, ref as storageRef, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";

  // --------- –í—Å—Ç–∞–≤—å —Å—é–¥–∞ —Å–≤–æ–π firebaseConfig (—Ç–≤—ñ–π praga-4baee) ----------
  const firebaseConfig = {
    apiKey: "AIzaSyDw_bVibsVyZegH7OJyZ_yRjI3uLhroVBk",
    authDomain: "praga-4baee.firebaseapp.com",
    databaseURL: "https://praga-4baee-default-rtdb.firebaseio.com",
    projectId: "praga-4baee",
    storageBucket: "praga-4baee.firebasestorage.app",
    messagingSenderId: "336023952536",
    appId: "1:336023952536:web:f7437feaa25b6eadcd04ed",
    measurementId: "G-BGDJD6R12N"
  };

  // Maps key (—Ç–æ–π, —â–æ —Ç–∏ –¥–∞–≤)
  const MAP_KEY = "AIzaSyBFrxVhpb6nHJ6rhiLl5Ho8t0jOb1iEQNc";

  // ---------- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ----------
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);
  const storage = getStorage(app);

  // DOM
  const tabButtons = document.querySelectorAll(".tab-button");
  const tabContents = document.querySelectorAll(".tab-content");
  const messagesEl = document.getElementById("messages");
  const messageInput = document.getElementById("messageInput");
  const sendButton = document.getElementById("sendButton");
  const fileInput = document.getElementById("fileInput");
  const authModal = document.getElementById("authModal");
  const registerForm = document.getElementById("registerForm");
  const loginForm = document.getElementById("loginForm");
  const nickInput = document.getElementById("nickInput");
  const emailInput = document.getElementById("emailInput");
  const passwordInput = document.getElementById("passwordInput");
  const registerSubmit = document.getElementById("registerSubmit");
  const loginShow = document.getElementById("loginShow");
  const loginSubmit = document.getElementById("loginSubmit");
  const backToRegister = document.getElementById("backToRegister");
  const loginEmail = document.getElementById("loginEmail");
  const loginPassword = document.getElementById("loginPassword");
  const modalClose = document.getElementById("modalClose");
  const profileBtn = document.getElementById("profileBtn");
  const chatArea = document.getElementById("chatArea");
  const regError = document.getElementById("regError");
  const loginError = document.getElementById("loginError");

  // State
  const DEFAULT_AVATAR = "https://i.ibb.co/Fqq6sH5q/istockphoto-1495088043-612x612.jpg";
  let currentUser = null;

  // Tabs
  function setActiveTab(id){
    tabButtons.forEach(b => b.classList.toggle("active", b.dataset.target === id));
    tabContents.forEach(c => c.style.display = (c.id === id) ? "block" : "none");
    if (id === "chatTab") messageInput.focus();
  }
  tabButtons.forEach(btn => btn.addEventListener("click", ()=> setActiveTab(btn.dataset.target)));

  // Auth modal helpers
  function showAuthModal(){ authModal.classList.add("show"); authModal.setAttribute("aria-hidden","false"); regError.textContent = ""; loginError.textContent = ""; }
  function hideAuthModal(){ authModal.classList.remove("show"); authModal.setAttribute("aria-hidden","true"); }
  modalClose?.addEventListener("click", hideAuthModal);
  loginShow?.addEventListener("click", ()=>{ registerForm.style.display="none"; loginForm.style.display="block"; });
  backToRegister?.addEventListener("click", ()=>{ registerForm.style.display="block"; loginForm.style.display="none"; });

  // Registration
  registerSubmit?.addEventListener("click", async ()=>{
    regError.textContent = "";
    const nick = nickInput.value.trim();
    const email = emailInput.value.trim();
    const pass = passwordInput.value.trim();
    if (!nick || !email || !pass) { regError.textContent = "–ó–∞–ø–æ–≤–Ω—ñ—Ç—å —É—Å—ñ –ø–æ–ª—è"; return; }
    if (pass.length < 6) { regError.textContent = "–ü–∞—Ä–æ–ª—å –º–∞—î –±—É—Ç–∏ –º—ñ–Ω—ñ–º—É–º 6 —Å–∏–º–≤–æ–ª—ñ–≤"; return; }
    try {
      const cred = await createUserWithEmailAndPassword(auth, email, pass);
      await updateProfile(cred.user, { displayName: nick, photoURL: DEFAULT_AVATAR });
      // –∑–∞–ø–∏—Å createdAt —É Realtime DB
      await dbPush(dbRef(db, `users/${cred.user.uid}`), { nick, createdAt: Date.now(), email, avatar: DEFAULT_AVATAR });
      localStorage.setItem("regTime_" + cred.user.uid, String(Date.now()));
      await sendEmailVerification(cred.user);
      hideAuthModal();
      alert("–í–∏ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω—ñ. –õ–∏—Å—Ç –¥–ª—è –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ. –£ –≤–∞—Å 6 –≥–æ–¥–∏–Ω –¥–æ—Å—Ç—É–ø—É –±–µ–∑ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è.");
    } catch (err) {
      console.error("register err", err);
      regError.textContent = err?.message || String(err);
    }
  });

  // Login
  loginSubmit?.addEventListener("click", async ()=>{
    loginError.textContent = "";
    const email = loginEmail.value.trim();
    const pass = loginPassword.value.trim();
    if (!email || !pass) { loginError.textContent = "–ó–∞–ø–æ–≤–Ω—ñ—Ç—å email —ñ –ø–∞—Ä–æ–ª—å"; return; }
    try {
      await signInWithEmailAndPassword(auth, email, pass);
      hideAuthModal();
    } catch (err) {
      console.error("login err", err);
      loginError.textContent = err?.message || String(err);
    }
  });

  // Auth state
  onAuthStateChanged(auth, (user)=>{
    currentUser = user;
    if (user) profileBtn.style.background = `url(${user.photoURL || DEFAULT_AVATAR}) center/cover`;
    else profileBtn.style.background = `url(${DEFAULT_AVATAR}) center/cover`;
  });

  // Messages: listen via single query (loads last N and future ones)
  const MESSAGES_TO_LOAD = 200;
  const messagesQuery = query(dbRef(db, "messages"), orderByChild("ts"), limitToLast(MESSAGES_TO_LOAD));

  // render one message
  function timeStr(ts){ return new Date(ts).toLocaleString(); }
  function renderMessage(m){
    // prevent rendering system duplicates
    if (!m || !m.ts) return;
    const wrap = document.createElement("div");
    wrap.className = "message" + ((currentUser && m.uid === currentUser.uid) ? " self" : "");
    const avatar = document.createElement("img");
    avatar.className = "avatar";
    avatar.src = m.avatar || DEFAULT_AVATAR;
    avatar.alt = m.nick || "avatar";
    avatar.title = m.nick || "–û—Å–æ–±–∏—Å—Ç—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è";
    // avatar click could open DM - placeholder
    avatar.addEventListener("click", ()=> {
      if (!currentUser) { showAuthModal(); return; }
      if (m.uid === currentUser.uid) alert("–¶–µ –≤–∏"); else alert("–í—ñ–¥–∫—Ä–∏–≤–∞—î—Ç—å—Å—è –æ—Å–æ–±–∏—Å—Ç–∏–π —á–∞—Ç (–ø—ñ–∑–Ω—ñ—à–µ)");
    });

    const txt = document.createElement("div");
    txt.className = "message-content";
    const meta = document.createElement("div");
    meta.className = "message-meta";
    meta.textContent = `${m.nick || "–ê–Ω–æ–Ω—ñ–º"} ¬∑ ${timeStr(m.ts)}` + (m.recipientUid ? " ¬∑ –æ—Å–æ–±–∏—Å—Ç–µ" : "");
    txt.appendChild(meta);
    if (m.text) {
      const p = document.createElement("div");
      p.innerText = m.text;
      txt.appendChild(p);
    }
    if (m.image) {
      const im = document.createElement("img");
      im.src = m.image;
      im.alt = "–§–æ—Ç–æ";
      im.className = "chat-image";
      txt.appendChild(im);
    }
    wrap.appendChild(avatar);
    wrap.appendChild(txt);
    messagesEl.appendChild(wrap);
    // keep scroll near bottom
    if (chatArea.scrollTop + chatArea.clientHeight >= chatArea.scrollHeight - 160) {
      chatArea.scrollTop = chatArea.scrollHeight;
    }
  }

  // subscribe
  onChildAdded(messagesQuery, (snap) => {
    const m = snap.val();
    renderMessage(m);
  }, (err) => {
    console.error("onChildAdded error:", err);
  });

  // send message
  async function canSendMessage(){
    const u = auth.currentUser;
    if (!u) return false;
    if (u.emailVerified) return true;
    const localKey = "regTime_" + u.uid;
    const localVal = localStorage.getItem(localKey);
    const sixHours = 6 * 60 * 60 * 1000;
    if (localVal && (Date.now() - Number(localVal) < sixHours)) return true;
    // Try getting createdAt from DB is omitted for simplicity (you can add)
    return false;
  }

  sendButton.addEventListener("click", async ()=>{
    if (!auth.currentUser) { showAuthModal(); return; }
    if (!await canSendMessage()) { alert("–ü—ñ–¥—Ç–≤–µ—Ä–¥—ñ—Ç—å email –∞–±–æ —Å–∫–æ—Ä–∏—Å—Ç–∞–π—Ç–µ—Å—å 6-–≥–æ–¥–∏–Ω–Ω–∏–º –¥–æ—Å—Ç—É–ø–æ–º –ø—ñ—Å–ª—è —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó."); return; }

    const text = messageInput.value.trim();
    const file = fileInput.files[0];
    if (!text && !file) return;

    let imageUrl = null;
    if (file) {
      try {
        const sRef = storageRef(storage, `chat_images/${auth.currentUser.uid}/${Date.now()}_${file.name}`);
        const uploadTask = uploadBytesResumable(sRef, file);
        await new Promise((res, rej)=>{
          uploadTask.on('state_changed', null, (err)=> rej(err), async ()=>{
            imageUrl = await getDownloadURL(uploadTask.snapshot.ref);
            res();
          });
        });
      } catch (e) {
        console.error("upload error", e);
        alert("–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–æ—Ç–æ");
        return;
      }
    }

    const msg = {
      uid: auth.currentUser.uid,
      nick: auth.currentUser.displayName || auth.currentUser.email || "–ê–Ω–æ–Ω—ñ–º",
      avatar: auth.currentUser.photoURL || DEFAULT_AVATAR,
      text: text || null,
      image: imageUrl || null,
      ts: Date.now(),
      recipientUid: null
    };

    try {
      await dbPush(dbRef(db, "messages"), msg);
      messageInput.value = "";
      fileInput.value = "";
      // we rely on onChildAdded to render the message
    } catch (e) {
      console.error("send error", e);
      alert("–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è");
    }
  });

  // Enter to send
  messageInput.addEventListener("keydown", (e)=>{
    if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); sendButton.click(); }
  });

  // file label click - require auth
  document.querySelector('label[for="fileInput"]').addEventListener("click", (e)=>{
    if (!auth.currentUser) { e.preventDefault(); showAuthModal(); return; }
  });

  // Profile button - simple: open modal if not logged, otherwise sign out
  profileBtn.style.background = `url(${DEFAULT_AVATAR}) center/cover`;
  profileBtn.addEventListener("click", ()=>{
    if (!auth.currentUser) { showAuthModal(); return; }
    if (confirm("–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –Ω–æ–≤–∏–π –∞–≤–∞—Ç–∞—Ä? –í—ñ–¥–º—ñ–Ω–∞ ‚Äî –≤–∏–π—Ç–∏ –∑ –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É.")) {
      const up = document.createElement("input"); up.type = "file"; up.accept = "image/*"; up.style.display="none";
      up.addEventListener("change", async ()=> {
        const f = up.files[0];
        if (!f) return;
        try {
          const sRef = storageRef(storage, `avatars/${auth.currentUser.uid}/${Date.now()}_${f.name}`);
          const uploadTask = uploadBytesResumable(sRef, f);
          await new Promise((res, rej)=>{
            uploadTask.on('state_changed', null, async ()=>{}, err=>rej(err), async ()=>{
              const url = await getDownloadURL(uploadTask.snapshot.ref);
              await updateProfile(auth.currentUser, { photoURL: url });
              profileBtn.style.background = `url(${url}) center/cover`;
              alert("–ê–≤–∞—Ç–∞—Ä –æ–Ω–æ–≤–ª–µ–Ω–æ");
              res();
            });
          });
        } catch (e) { console.error(e); alert("–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∞–≤–∞—Ç–∞—Ä–∞"); }
      });
      document.body.appendChild(up);
      up.click();
    } else {
      auth.signOut();
      profileBtn.style.background = `url(${DEFAULT_AVATAR}) center/cover`;
      alert("–í–∏ –≤–∏–π—à–ª–∏");
    }
  });

  // ----------------- Map (same markers) -----------------
  const ICONS = {
    hospital: "https://i.ibb.co/TqWJ9VTM/palata-vchehii-jpg.webp",
    lawyer: "https://i.ibb.co/0gWD5wW/images-5.jpg",
    shop: "https://i.ibb.co/R49shL6k/images-6.jpg",
    help: "https://i.ibb.co/Fqq6sH5q/istockphoto-1495088043-612x612.jpg"
  };

  const POINTS = [
    { title: "Motol Hospital", pos:{lat:50.057, lng:14.378}, cat:"hospital"},
    { title: "Nemocnice Na Frantisku", pos:{lat:50.085, lng:14.420}, cat:"hospital"},
    { title: "Klinika Praha", pos:{lat:50.078, lng:14.422}, cat:"hospital"},
    { title: "Pravni pomoc centrum A", pos:{lat:50.083, lng:14.412}, cat:"lawyer"},
    { title: "Pravni pomoc centrum B", pos:{lat:50.089, lng:14.430}, cat:"lawyer"},
    { title: "Advokatni kancelar C", pos:{lat:50.071, lng:14.425}, cat:"lawyer"},
    { title: "Albert Supermarket", pos:{lat:50.084, lng:14.417}, cat:"shop"},
    { title: "Billa City", pos:{lat:50.076, lng:14.437}, cat:"shop"},
    { title: "Kaufland Praha", pos:{lat:50.085, lng:14.414}, cat:"shop"},
    { title: "Pomoc Centrum 1", pos:{lat:50.082, lng:14.419}, cat:"help"},
    { title: "Pomoc Centrum 2", pos:{lat:50.088, lng:14.427}, cat:"help"},
    { title: "Shelter Point", pos:{lat:50.074, lng:14.432}, cat:"help"},
    { title: "Clinic D", pos:{lat:50.090, lng:14.418}, cat:"hospital"},
    { title: "Clinic E", pos:{lat:50.079, lng:14.404}, cat:"hospital"},
    { title: "Law Office D", pos:{lat:50.081, lng:14.440}, cat:"lawyer"},
    { title: "Law Office E", pos:{lat:50.075, lng:14.433}, cat:"lawyer"},
    { title: "Shop D", pos:{lat:50.083, lng:14.445}, cat:"shop"},
    { title: "Shop E", pos:{lat:50.0715, lng:14.421}, cat:"shop"},
    { title: "Help Center 3", pos:{lat:50.086, lng:14.431}, cat:"help"},
    { title: "Help Center 4", pos:{lat:50.072, lng:14.439}, cat:"help"},
    { title: "Medical Aid 8", pos:{lat:50.0875, lng:14.435}, cat:"hospital"},
    { title: "Legal Aid 9", pos:{lat:50.0785, lng:14.410}, cat:"lawyer"},
    { title: "Community Aid", pos:{lat:50.0835, lng:14.425}, cat:"help"},
    { title: "Pharmacy 1", pos:{lat:50.088, lng:14.420}, cat:"shop"}
  ];

  let map, markers = [];
  function createIconFor(cat){ const url = ICONS[cat] || ICONS.help; return { url, scaledSize: new google.maps.Size(40,40) }; }
  function renderMarkers(filterCat="all"){
    markers.forEach(m=>m.setMap(null)); markers = [];
    POINTS.forEach(p=>{
      if (filterCat === "all" || p.cat === filterCat) {
        const mk = new google.maps.Marker({ position: p.pos, map, title: p.title, icon: createIconFor(p.cat) });
        const inf = new google.maps.InfoWindow({ content: `<strong>${p.title}</strong><div>${p.cat}</div>` });
        mk.addListener("click", ()=> inf.open(map, mk));
        markers.push(mk);
      }
    });
  }
  function attachMapFilterButtons(){ document.querySelectorAll(".filter-btn").forEach(btn=>{ btn.addEventListener("click", ()=>{ document.querySelectorAll(".filter-btn").forEach(b=>b.classList.remove("active")); btn.classList.add("active"); renderMarkers(btn.dataset.cat); }); }); }

  window.initMap = function(){
    const center = { lat: 50.0755, lng: 14.4378 };
    map = new google.maps.Map(document.getElementById("map"), { center, zoom:13, gestureHandling:"greedy" });
    renderMarkers("all");
    attachMapFilterButtons();
    window._mapReady = true;
  };

  (function loadMaps(){ const s = document.createElement("script"); s.src = `https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(MAP_KEY)}&callback=initMap`; s.defer=true; s.async=true; s.onerror = ()=> { console.error("Google Maps failed to load"); alert("–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–∞—Ä—Ç–∏ ‚Äî –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ –∫–ª—é—á —ñ –≤–∫–ª—é—á–µ–Ω—ñ API."); }; document.head.appendChild(s); })();

  </script>
</body>
</html>
