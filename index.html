<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Прага-Фушки — Допомога українцям у Празі</title>

<!-- Leaflet CSS -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
  integrity="sha256-sA+oPH8p8+k7ipK33Jg1G3Eql9fF+v9Z3Ighz2sPvkM="
  crossorigin=""
/>

<style>
  /* Сброс */
  * {
    box-sizing: border-box;
  }
  body, html {
    margin: 0; padding: 0;
    height: 100%;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: url('https://i.ibb.co/fbpjfnm/Prague.jpg') no-repeat center center fixed;
    background-size: cover;
    color: #fff;
  }
  /* Контейнер и навигация вкладок */
  .container {
    height: 100vh;
    display: flex;
    flex-direction: column;
    background: rgba(0,0,0,0.55);
  }
  nav {
    display: flex;
    background: rgba(0,0,0,0.7);
  }
  nav button {
    flex: 1;
    padding: 15px 0;
    border: none;
    background: transparent;
    color: #ddd;
    font-weight: 600;
    font-size: 1.1rem;
    cursor: pointer;
    transition: background 0.3s, color 0.3s;
  }
  nav button.active, nav button:hover {
    background: #ffc107;
    color: #111;
  }
  /* Контент вкладок */
  .tab-content {
    flex: 1;
    overflow: hidden;
    position: relative;
  }
  .tab-panel {
    display: none;
    height: 100%;
    overflow-y: auto;
    padding: 15px;
  }
  .tab-panel.active {
    display: block;
  }

  /* Чат */
  #chat {
    display: flex;
    flex-direction: column;
    height: 100%;
    background: rgba(20, 20, 20, 0.85);
    border-radius: 10px;
  }
  #chat-header {
    padding: 10px 15px;
    background: #222;
    font-size: 0.9rem;
    text-align: center;
    font-weight: 600;
    color: #ffd54f;
  }
  #messages {
    flex: 1;
    overflow-y: auto;
    padding: 10px 15px;
    font-size: 0.9rem;
    line-height: 1.3;
  }
  .message {
    margin-bottom: 10px;
    max-width: 80%;
    padding: 8px 12px;
    border-radius: 12px;
    word-wrap: break-word;
  }
  .message.sent {
    background: #ffc107;
    color: #111;
    align-self: flex-end;
  }
  .message.received {
    background: #444;
    color: #fff;
    align-self: flex-start;
  }
  .message img {
    max-width: 100%;
    border-radius: 8px;
    margin-top: 5px;
  }
  #input-area {
    display: flex;
    padding: 10px 15px;
    background: #222;
    align-items: center;
    gap: 8px;
  }
  #text-input {
    flex: 1;
    padding: 8px 12px;
    border-radius: 20px;
    border: none;
    font-size: 1rem;
  }
  #text-input:focus {
    outline: none;
  }
  #send-btn, #photo-btn {
    background: #ffc107;
    border: none;
    border-radius: 50%;
    width: 38px;
    height: 38px;
    cursor: pointer;
    display: flex;
    justify-content: center;
    align-items: center;
    transition: background 0.3s;
  }
  #send-btn:hover, #photo-btn:hover {
    background: #ffca28;
  }
  #send-btn:disabled {
    background: #aaa;
    cursor: not-allowed;
  }
  #file-input {
    display: none;
  }

  /* Форма регистрации (модалка) */
  #register-modal {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.8);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 1000;
  }
  #register-modal.active {
    display: flex;
  }
  #register-form {
    background: #222;
    padding: 20px 30px;
    border-radius: 12px;
    width: 320px;
    box-shadow: 0 0 10px #000;
    color: #fff;
  }
  #register-form h2 {
    margin-top: 0;
    margin-bottom: 15px;
    text-align: center;
    color: #ffc107;
  }
  #register-form label {
    display: block;
    margin: 8px 0 4px 0;
  }
  #register-form input {
    width: 100%;
    padding: 8px 10px;
    border-radius: 6px;
    border: none;
    font-size: 1rem;
  }
  #register-form input:focus {
    outline: none;
  }
  #register-submit {
    margin-top: 15px;
    background: #ffc107;
    color: #111;
    border: none;
    padding: 10px 0;
    font-weight: 600;
    width: 100%;
    border-radius: 10px;
    cursor: pointer;
    transition: background 0.3s;
  }
  #register-submit:hover {
    background: #ffca28;
  }
  #register-error {
    color: #f44336;
    margin-top: 8px;
    font-size: 0.9rem;
    min-height: 20px;
  }

  /* Карта */
  #map {
    height: 100%;
    border-radius: 10px;
  }
  /* Фильтр маркеров */
  .filter-buttons {
    margin-bottom: 8px;
    text-align: center;
  }
  .filter-buttons button {
    margin: 0 4px;
    padding: 6px 14px;
    background: #444;
    border: none;
    border-radius: 6px;
    color: #eee;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.3s;
  }
  .filter-buttons button.active, .filter-buttons button:hover {
    background: #ffc107;
    color: #111;
  }

  /* Информация */
  #info-panel {
    background: rgba(0,0,0,0.8);
    border-radius: 10px;
    padding: 15px;
    overflow-y: auto;
    height: 100%;
  }
  #info-panel h2 {
    color: #ffc107;
    margin-top: 0;
  }
  #info-panel p {
    font-size: 1rem;
    line-height: 1.3;
    margin-bottom: 10px;
  }
  #info-panel img {
    width: 100%;
    max-width: 400px;
    border-radius: 10px;
    margin-bottom: 10px;
  }

  /* Адаптивность */
  @media (max-width: 768px) {
    nav button {
      font-size: 1rem;
      padding: 10px 0;
    }
    #register-form {
      width: 90vw;
      padding: 15px 20px;
    }
    #info-panel img {
      max-width: 100%;
    }
  }

</style>

</head>
<body>
<div class="container">

  <nav>
    <button class="active" data-tab="chat">Чат Прага-Фушки</button>
    <button data-tab="map">Карта допомоги</button>
    <button data-tab="info">Корисна інформація</button>
  </nav>

  <div class="tab-content">
    <!-- Чат -->
    <section id="chat" class="tab-panel active">
      <div id="chat-header">Шановні українці! Цей сайт створено, щоб допомагати нашим співвітчизникам.</div>
      <div id="messages"></div>
      <div id="input-area">
        <input id="text-input" type="text" placeholder="Напишіть повідомлення..." autocomplete="off" />
        <label for="file-input" id="photo-btn" title="Додати фото">&#128247;</label>
        <input type="file" id="file-input" accept="image/*" />
        <button id="send-btn" disabled>Відправити</button>
      </div>
    </section>

    <!-- Карта -->
    <section id="map" class="tab-panel">
      <div class="filter-buttons">
        <button class="active" data-filter="all">Усі</button>
        <button data-filter="medicine">Медицина</button>
        <button data-filter="social">Соцслужби</button>
        <button data-filter="shops">Магазини</button>
        <button data-filter="law">Юридична допомога</button>
      </div>
      <div id="map" style="height: calc(100% - 40px); border-radius: 10px;"></div>
    </section>

    <!-- Информация -->
    <section id="info" class="tab-panel">
      <div id="info-panel">
        <h2>Корисна інформація для українців у Празі</h2>
        <p>Прага-Фушки — це місце, де ви можете отримати допомогу, знайти контакти медичних установ, волонтерських організацій, юридичних консультацій і магазинів з українськими товарами.</p>
        <img src="https://images.unsplash.com/photo-1549924231-f129b911e442?auto=format&fit=crop&w=400&q=80" alt="Прага вночі" />
        <p>Звертайтесь до волонтерських центрів, отримуйте юридичну допомогу, знаходьте аптечні пункти і продуктові магазини з українськими товарами.</p>
        <img src="https://images.unsplash.com/photo-1529307470987-9ee3bde9b302?auto=format&fit=crop&w=400&q=80" alt="Волонтерська допомога" />
        <p>Якщо потрібна медична допомога, одразу звертайтесь до лікарень, які вказані на карті. Будьте здорові!</p>
      </div>
    </section>
  </div>
</div>

<!-- Форма регистрации -->
<div id="register-modal">
  <form id="register-form">
    <h2>Реєстрація</h2>
    <label for="nickname">Нікнейм</label>
    <input type="text" id="nickname" required autocomplete="off" />
    <label for="email">Електронна пошта</label>
    <input type="email" id="email" required autocomplete="off" />
    <label for="password">Пароль</label>
    <input type="password" id="password" required autocomplete="off" />
    <button type="submit" id="register-submit">Зареєструватися</button>
    <div id="register-error"></div>
  </form>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-analytics-compat.js"></script>

<!-- Leaflet JS -->
<script
  src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"
  integrity="sha256-o9N1jOG8Ck0D62x6fUL1TXu/6bW5pAz5O1I4R3LrpZY="
  crossorigin=""
></script>

<script>
  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyDV2BslF-Ll37a1XO3GEfzNMXa7YsSXL1o",
    authDomain: "web-app-b4633.firebaseapp.com",
    databaseURL: "https://web-app-b4633-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "web-app-b4633",
    storageBucket: "web-app-b4633.firebasestorage.app",
    messagingSenderId: "1041887915171",
    appId: "1:1041887915171:web:84d62eae54e9291b47a316",
    measurementId: "G-C65BPE81SJ"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  firebase.analytics();

  const auth = firebase.auth();
  const db = firebase.database();

  // DOM Elements
  const tabs = document.querySelectorAll('nav button');
  const panels = document.querySelectorAll('.tab-panel');
  const messagesContainer = document.getElementById('messages');
  const textInput = document.getElementById('text-input');
  const sendBtn = document.getElementById('send-btn');
  const fileInput = document.getElementById('file-input');
  const photoBtn = document.getElementById('photo-btn');

  const registerModal = document.getElementById('register-modal');
  const registerForm = document.getElementById('register-form');
  const nicknameInput = document.getElementById('nickname');
  const emailInput = document.getElementById('email');
  const passwordInput = document.getElementById('password');
  const registerError = document.getElementById('register-error');

  let currentUser = null;

  // Управление вкладками
  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      tabs.forEach(b => b.classList.remove('active'));
      tab.classList.add('active');
      const target = tab.dataset.tab;
      panels.forEach(p => {
        p.classList.toggle('active', p.id === target);
      });
    });
  });

  // Адаптивность кнопки Отправить
  function updateSendButtonState() {
    sendBtn.disabled = textInput.value.trim() === '' && fileInput.files.length === 0;
  }
  textInput.addEventListener('input', updateSendButtonState);
  fileInput.addEventListener('change', updateSendButtonState);

  // Загрузка сообщений из Firebase и вывод
  function renderMessages(messages) {
    messagesContainer.innerHTML = '';
    messages.forEach(msg => {
      const div = document.createElement('div');
      div.className = 'message ' + (msg.uid === currentUser?.uid ? 'sent' : 'received');
      div.innerHTML = `<strong>${msg.nickname || 'Анонім'}:</strong> ${msg.text || ''}`;
      if(msg.imageUrl) {
        div.innerHTML += `<br><img src="${msg.imageUrl}" alt="Фото">`;
      }
      messagesContainer.appendChild(div);
    });
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }

  // Подписка на сообщения в базе
  function subscribeMessages() {
    const messagesRef = db.ref('messages').limitToLast(100);
    messagesRef.off();
    messagesRef.on('value', snapshot => {
      const val = snapshot.val();
      const msgs = val ? Object.values(val) : [];
      renderMessages(msgs);
    });
  }

  // Функция отправки сообщения
  async function sendMessage(text, file) {
    if(!currentUser) {
      // Показываем форму регистрации
      registerModal.classList.add('active');
      return;
    }
    const nickname = nicknameInput.value || 'Анонім';

    let imageUrl = null;
    if(file) {
      try {
        const storageRef = firebase.storage().ref();
        const imageRef = storageRef.child(`images/${Date.now()}_${file.name}`);
        await imageRef.put(file);
        imageUrl = await imageRef.getDownloadURL();
      } catch(e) {
        alert('Помилка завантаження фото');
      }
    }

    const newMsg = {
      uid: currentUser.uid,
      nickname: nickname,
      text: text || '',
      imageUrl: imageUrl || null,
      timestamp: Date.now()
    };

    await db.ref('messages').push(newMsg);
  }

  // Обработчик нажатия кнопки "Отправити"
  sendBtn.addEventListener('click', async () => {
    const text = textInput.value.trim();
    const file = fileInput.files[0] || null;
    if (!text && !file) return;

    sendBtn.disabled = true;

    try {
      await sendMessage(text, file);
      textInput.value = '';
      fileInput.value = null;
      updateSendButtonState();
    } catch (e) {
      alert('Помилка при відправленні повідомлення.');
    }

    sendBtn.disabled = false;
  });

  // Форма регистрации
  registerForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    registerError.textContent = '';

    const nickname = nicknameInput.value.trim();
    const email = emailInput.value.trim();
    const password = passwordInput.value;

    if (!nickname || !email || !password) {
      registerError.textContent = 'Всі поля обовʼязкові для заповнення.';
      return;
    }

    try {
      const userCredential = await auth.createUserWithEmailAndPassword(email, password);
      currentUser = userCredential.user;

      // Сохраняем никнейм в профиле Firebase Auth
      await currentUser.updateProfile({ displayName: nickname });

      registerModal.classList.remove('active');
      nicknameInput.value = '';
      emailInput.value = '';
      passwordInput.value = '';

      subscribeMessages();

    } catch (error) {
      registerError.textContent = error.message;
    }
  });

  // Отслеживаем состояние авторизации
  auth.onAuthStateChanged(user => {
    currentUser = user;
    if (user) {
      // Пользователь авторизован — сразу загружаем сообщения
      subscribeMessages();
    } else {
      // Пользователь не авторизован — очистить чат
      messagesContainer.innerHTML = '<p style="text-align:center; color:#bbb;">Вхід не виконано. Напишіть повідомлення, щоб зареєструватись.</p>';
    }
  });

  // При клике по кнопке "Отправить" если неавторизован — открываем регистрацию
  sendBtn.addEventListener('click', () => {
    if (!currentUser) {
      registerModal.classList.add('active');
    }
  });

  // При клике вне формы регистрации закрыть её
  registerModal.addEventListener('click', (e) => {
    if (e.target === registerModal) {
      registerModal.classList.remove('active');
    }
  });

  // Инициализация карты Leaflet
  const map = L.map('map').setView([50.0755, 14.4378], 13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  const categories = {
    all: [],
    medicine: [
      { name: 'Лікарня Мотол', lat: 50.0737, lng: 14.3456 },
      { name: 'Поліклініка Прага 1', lat: 50.082, lng: 14.423 },
      { name: 'Аптека "Здоров’я"', lat: 50.074, lng: 14.435 },
      { name: 'Центр вакцинації', lat: 50.078, lng: 14.440 }
    ],
    social: [
      { name: 'OAMP Прага 1', lat: 50.087, lng: 14.423 },
      { name: 'Волонтерський центр Pomoc', lat: 50.081, lng: 14.449 },
      { name: 'Український культурний центр', lat: 50.083, lng: 14.426 }
    ],
    shops: [
      { name: 'Магазин Pomoc', lat: 50.073, lng: 14.418 },
      { name: 'Український магазин "Дніпро"', lat: 50.079, lng: 14.433 }
    ],
    law: [
      { name: 'Консультація Pravda', lat: 50.085, lng: 14.420 },
      { name: 'Юридична допомога для українців', lat: 50.080, lng: 14.427 }
    ]
  };
  // Заполняем all
  for (let cat in categories) {
    if (cat !== 'all') categories.all.push(...categories[cat]);
  }

  let markers = [];
  function renderMarkers(filter) {
    markers.forEach(m => map.removeLayer(m));
    markers = [];
    categories[filter].forEach(point => {
      const marker = L.marker([point.lat, point.lng]).addTo(map).bindPopup(point.name);
      markers.push(marker);
    });
  }

  renderMarkers('all');

  // Обработчик кнопок фильтра на карте
  document.querySelectorAll('.filter-buttons button').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.filter-buttons button').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      renderMarkers(btn.dataset.filter);
    });
  });

</script>

</body>
</html>

